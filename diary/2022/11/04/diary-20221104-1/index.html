<!DOCTYPE HTML>
<html lang="zh-CN">
    


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android学习-2, 车舟慢">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="KeoTn_OFy4ndJwXNmm2gMeQfPhd7alqE9vQDwI32KCY">
    <meta name="description" content="MVVM
数据驱动  

在常规的开发模式中，数据变化需要更新UI的时候，需要先获取UI控件的引用，然后再更新UI。获取用户的输入和操作也需要通过UI控件的引用。  
在MVVM中，这些都是通过数据驱动来自动完成的，数据变化后会自动更新UI">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android学习-2 | 车舟慢</title>
    <link rel="icon" type="image/png" href="/diary/favicon.png">

    <link rel="stylesheet" type="text/css" href="/diary/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/diary/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/diary/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/diary/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/diary/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/diary/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/diary/css/my.css">
    
    <style type="text/css">
        
    </style>

    <script src="/diary/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

<link rel="stylesheet" href="/diary/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/diary/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/diary/" class="waves-effect waves-light">
                    
                    <img src="/diary/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">车舟慢</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/diary/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/diary/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/diary/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/diary/demo/shuoshuo" class="waves-effect waves-light">
            
            <i class="fa fa-music"></i>
            
            <span>说说</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/diary/galleries" class="waves-effect waves-light">
            
            <i class="fa fa-photo"></i>
            
            <span>相册</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/diary/" class="waves-effect waves-light">
              
                <i class="fa fa-home"></i>
              
              <span>首页</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/diary/categories" class="waves-effect waves-light">
              
                <i class="fa fa-bookmark"></i>
              
              <span>分类</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/diary/archives" class="waves-effect waves-light">
              
                <i class="fa fa-archive"></i>
              
              <span>归档</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/diary/demo/shuoshuo" class="waves-effect waves-light">
              
                <i class="fa fa-music"></i>
              
              <span>说说</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/diary/galleries" class="waves-effect waves-light">
              
                <i class="fa fa-photo"></i>
              
              <span>相册</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/diary/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">车舟慢</div>
        <div class="logo-desc">
            
            雁引愁心去，山衔好月来。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/diary/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/diary/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/diary/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/diary/demo/shuoshuo" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-music"></i>
                
                说说
            </a>
        </li>
        
        <li>
            <a href="/diary/galleries" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-photo"></i>
                
                相册
            </a>
        </li>
        
        
    </ul>

   
   
<!-- 支持二级菜单特性   -->
<!-- <ul class="menu-list mobile-menu-list">
    
        <li class="m-nav-item">
                
                    <a href="/diary/" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-home"></i>
                        
                        首页
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/diary/categories" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-bookmark"></i>
                        
                        分类
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/diary/archives" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-archive"></i>
                        
                        归档
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/diary/demo/shuoshuo" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-music"></i>
                        
                        说说
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/diary/galleries" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-photo"></i>
                        
                        相册
                    </a>
              
            </li>
        

        
    </ul> -->

</div>

        </div>

        
    </nav>

</header>

        
<script src="/diary/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/diary/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/diary/medias/featureimages/18.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android学习-2
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/diary/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/diary/tags/Android/" target="_blank">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>
            
            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-11-04
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                        seanzs
                    
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        18.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        82 分
                    </div>
                    
                
                
                

            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h2><blockquote>
<p>数据驱动  </p>
</blockquote>
<p>在常规的开发模式中，数据变化需要更新UI的时候，需要先获取UI控件的引用，然后再更新UI。获取用户的输入和操作也需要通过UI控件的引用。  </p>
<p>在MVVM中，这些都是通过数据驱动来自动完成的，数据变化后会自动更新UI，UI的改变也能自动反馈到数据层，数据成为主导因素  </p>
<p>MVVM层在业务逻辑处理中只要关心数据，不需要直接和UI打交道，在业务处理过程中简单方便很多  </p>
<blockquote>
<p>低耦合度  </p>
</blockquote>
<p>MVVM模式中，数据是独立于UI的,数据和业务逻辑处于一个独立的ViewModel中，ViewModel只需要关注数据和业务逻辑，不需要和UI或者控件打交道。UI想怎么处理数据都由UI自己决定，ViewModel不涉及任何和UI相关的事，也不持有UI控件的引用。即便是控件改变了（比如：TextView换成EditText），ViewModel也几乎不需要更改任何代码。它非常完美的解耦了View层和ViewModel，解决了上面我们所说的MVP的痛点。  </p>
<blockquote>
<p>更新UI  </p>
</blockquote>
<p>在MVVM中，数据发生变化后，我们在工作线程直接修改ViewModel的数据即可（在数据是线程安全的情况下），不用再考虑要切到主线程更新UI了，这些事情相关框架都帮我们做了。  </p>
<blockquote>
<p>团队协作  </p>
</blockquote>
<p>MVVM的分工是非常明显的，由于View和ViewModel之间是松散耦合的：一个是处理业务和数据、一个是专门的UI处理。所以，完全由两个人分工来做，一个做UI（XML和Activity）一个写ViewModel，效率更高。  </p>
<blockquote>
<p>可复用性  </p>
</blockquote>
<p>一个ViewModel可以复用到多个View中。同样的一份数据，可以提供给不同的UI去做展示。对于版本迭代中频繁的UI改动，更新或新增一套View即可。  </p>
<blockquote>
<p>单元测试  </p>
</blockquote>
<p>我们前面说过了，ViewModel层做的事是数据处理和业务逻辑，View层中关注的是UI，两者完全没有依赖。不管是UI的单元测试还是业务逻辑的单元测试，都是低耦合的。在MVVM中数据是直接绑定到UI控件上的（部分数据是可以直接反映出UI上的内容），那么我们就可以直接通过修改绑定的数据源来间接做一些Android UI上的测试。  </p>
<h3 id="MVVM框架各模块分工"><a href="#MVVM框架各模块分工" class="headerlink" title="MVVM框架各模块分工"></a>MVVM框架各模块分工</h3><blockquote>
<p>View  </p>
</blockquote>
<p>View层做的就是和UI相关的工作，我们只在XML、Activity和Fragment写View层的代码，View层不做和业务相关的事，也就是我们在Activity不写业务逻辑和业务数据相关的代码，更新UI通过数据绑定实现，尽量在ViewModel里面做（更新绑定的数据源即可），Activity要做的事就是初始化一些控件（如控件的颜色，添加RecyclerView的分割线），View层可以提供更新UI的接口（但是我们更倾向所有的UI元素都是通过数据来驱动更改UI），View层可以处理事件（但是我们更希望UI事件通过Command来绑定）。简单地说：View层不做任何业务逻辑、不涉及操作数据、不处理数据，UI和数据严格的分开。  </p>
<blockquote>
<p>ViewModel  </p>
</blockquote>
<p>ViewModel层做的事情刚好和View层相反，ViewModel只做和业务逻辑和业务数据相关的事，不做任何和UI相关的事情，ViewModel 层不会持有任何控件的引用，更不会在ViewModel中通过UI控件的引用去做更新UI的事情。ViewModel就是专注于业务的逻辑处理，做的事情也都只是对数据的操作（这些数据绑定在相应的控件上会自动去更改UI）。同时DataBinding框架已经支持双向绑定，让我们可以通过双向绑定获取View层反馈给ViewModel层的数据，并对这些数据上进行操作。关于对UI控件事件的处理，我们也希望能把这些事件处理绑定到控件上，并把这些事件的处理统一化，为此我们通过BindingAdapter对一些常用的事件做了封装，把一个个事件封装成一个个Command，对于每个事件我们用一个ReplyCommand去处理就行了，ReplyCommand会把你可能需要的数据带给你，这使得我们在ViewModel层处理事件的时候只需要关心处理数据就行了。再强调一遍：ViewModel 不做和UI相关的事。  </p>
<blockquote>
<p>Model  </p>
</blockquote>
<p>Model层最大的特点是被赋予了数据获取的职责，与我们平常Model层只定义实体对象的行为截然不同。实例中，数据的获取、存储、数据状态变化都是Model层的任务。Model包括实体模型（Bean）、Retrofit的Service ，获取网络数据接口，本地存储（增删改查）接口，数据变化监听等。Model提供数据获取接口供ViewModel调用，经数据转换和操作并最终映射绑定到View层某个UI元素的属性上。  </p>
<blockquote>
<p>如何协作  </p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="../../../../images/2022/mvvm.jpg" alt="图1：MVVM各模块协作">   </p>
<h3 id="ViewModel与View的协作"><a href="#ViewModel与View的协作" class="headerlink" title="ViewModel与View的协作"></a>ViewModel与View的协作</h3><p>ViewModel和View是通过绑定的方式连接在一起的，绑定分成两种：一种是数据绑定，一种是命令绑定。数据的绑定DataBinding已经提供好了，简单地定义一些ObservableField就能把数据和控件绑定在一起了（如TextView的text属性），但是DataBinding框架提供的不够全面，比如说如何让一个URL绑定到一个ImageView，让这个ImageView能自动去加载url指定的图片，如何把数据源和布局模板绑定到一个ListView，让ListView可以不需要去写Adapter和ViewHolder相关的东西？这些就需要我们做一些工作和简单的封装。对于每个事件我们用一个ReplyCommand去处理就行了，ReplyCommand会把可能需要的数据带给你，这样我们处理事件的时候也只关心处理数据就行了。  </p>
<pre class="line-numbers language-html"><code class="language-html">ViewModel类下面一般包含下面5个部分  
1. Context （上下文）
2. Model (数据源 Java Bean)
3. Data Field （数据绑定）
4. Command （命令绑定）
5. Child ViewModel （子ViewModel）

先来看下示例代码，然后再一一讲解5个部分是干嘛用的  
//context
private Activity context;

//model（数据源 Java Bean）
private NewsService.News news;
private TopNewsService.News topNews;

//数据绑定，绑定到UI的字段（data field）
public final ObservableField<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> imageUrl = new ObservableField&lt;>();
public final ObservableField<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> html = new ObservableField&lt;>();
public final ObservableField<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> title = new ObservableField&lt;>();
// 一个变量包含了所有关于View Style 相关的字段
public final ViewStyle viewStyle = new ViewStyle();


//命令绑定（command）
public final ReplyCommand onRefreshCommand = new ReplyCommand&lt;>(() -> {    

})
public final ReplyCommand<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span> onLoadMoreCommand = new ReplyCommand&lt;>((itemCount) -> { 

});


//Child ViewModel
public final ObservableList<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NewItemViewModel</span><span class="token punctuation">></span></span> itemViewModel = new ObservableArrayList&lt;>();

/** * ViewStyle 关于控件的一些属性和业务数据无关的Style 可以做一个包裹，这样代码比较美观，
ViewModel 页面也不会有太多太杂的字段。 **/
public static class ViewStyle {    
   public final ObservableBoolean isRefreshing = new ObservableBoolean(true);    
   public final ObservableBoolean progressRefreshing = new ObservableBoolean(true);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ViewModel类中的Context</p>
<pre class="line-numbers language-html"><code class="language-html">Context是干嘛用的呢，为什么每个ViewModel都最好需要持了一个Context的引用呢？ViewModel不处理和UI相关的事也不操作控件，更不更新UI，那为什么要有Context呢？原因主要有以下两点：  

1. 通过图1中，然后得到一个Observable，其实这就是网络请求部分。其实这就是网络请求部分，做网络请求我们必须把Retrofit Service返回的Observable绑定到Context的生命周期上，防止在请求回来时Activity已经销毁等异常，其实这个Context的目的就是把网络请求绑定到当前页面的生命周期中。
2. 在图1中，我们可以看到两个ViewModel之间的联系是通过Messenger来做，这个Messenger是需要用到Context，这个我们后续会讲解。  
3. 除此以外，调用工具类、帮助类有时候需要Context做为参数等也是原因之一。  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ViewModel类中的Model数据源</p>
<pre class="line-numbers language-html"><code class="language-html">Model是什么呢？其实就是数据源，可以简单理解是我们用JSON转过来的Bean。ViewModel要把数据映射到UI中可能需要大量对Model的数据拷贝和操作，拿Model的字段去生成对应的ObservableField然后绑定到UI（我们不会直接拿Model的数据去做绑定展示），这里是有必要在一个ViewModel保留原始的Model引用，这对于我们是非常有用的，因为可能用户的某些操作和输入需要我们去改变数据源，可能我们需要把一个Bean在列表页点击后传给详情页，可能我们需要把这个Model当做表单提交到服务器。这些都需要我们的ViewModel持有相应的Model（数据源）。  
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ViewModel类中的Data Field（数据绑定）</p>
<pre class="line-numbers language-html"><code class="language-html">Data Field就是需要绑定到控件上的ObservableField字段，这是ViewModel的必需品，这个没有什么好说。但是这边有一个建议：
这些字段是可以稍微做一下分类和包裹的。比如说可能一些字段是绑定到控件的一些Style属性上（如长度、颜色、大小），对于这类针对View Style的的字段可以声明一个ViewStyle类包裹起来，这样整个代码逻辑会更清晰一些，不然ViewModel里面可能字段泛滥，不易管理和阅读性较差。而对于其他一些字段，比如说title、imageUrl、name这些属于数据源类型的字段，这些字段也叫数据字段，是和业务数据和逻辑息息相关的，这些字段可以放在一块。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ViewModel类中的Command命令绑定  </p>
<pre class="line-numbers language-html"><code class="language-html">Command（命令绑定）简言之就是对事件的处理（下拉刷新、加载更多、点击、滑动等事件处理）。我们之前处理事件是拿到UI控件的引用，然后设置Listener，这些Listener其实就是Command。但是考虑到在一个ViewModel写各种Listener并不美观，可能实现一个Listener就需要实现多个方法，但是我们可能只想要其中一个有用的方法实现就好了。更重要一点是实现一个Listener可能需要写一些UI逻辑才能最终获取我们想要的。简单举个例子，比如你想要监听ListView滑到最底部然后触发加载更多的事件，这时候就要在ViewModel里面写一个OnScrollListener，然后在里面的onScroll方法中做计算，计算什么时候ListView滑动底部了。其实ViewModel的工作并不想去处理这些事件，它专注做的应该是业务逻辑和数据处理，如果有一个东西不需要你自己去计算是否滑到底部，而是在滑动底部自动触发一个Command，同时把当前列表的总共的item数量返回给你，方便你通过 page=itemCount/LIMIT+1去计算出应该请求服务器哪一页的数据那该多好啊。  

public final ReplyCommand<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span> onLoadMoreCommand =  new ReplyCommand&lt;>((itemCount) -> { 
   int page=itemCount/LIMIT+1; 
   loadData(page.LIMIT)
});  

接着在XML布局文件中通过bind:onLoadMoreCommand绑定上去就行了。  

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>android.support.v7.widget.RecyclerView</span> 
 <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>  
 <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>  
 <span class="token attr-name"><span class="token namespace">bind:</span>onLoadMoreCommand</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{viewModel.loadMoreCommand}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

当然Command并不是必须的，你完全可以依照自己的习惯和喜好在ViewModel写Listener，不过使用Command可以使ViewModel更简洁易读。你也可以自己定义更多的、其他功能的Command，那么ViewModel的事件处理都是托管ReplyCommand来处理，这样的代码看起来会比较美观和清晰。Command只是对UI事件的一层隔离UI层的封装，在事件触发时把ViewModel层可能需要的数据传给ViewModel层，对事件的处理做了统一化，是否使用的话，还是看你个人喜好了。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ViewModel类中的Child ViewModel（子ViewModel）  </p>
<pre class="line-numbers language-html"><code class="language-html">子ViewModel的概念就是在ViewModel里面嵌套其他的ViewModel，这种场景还是很常见的。比如说你一个Activity里面有两个Fragment，ViewModel是以业务划分的，两个Fragment做的业务不一样，自然是由两个ViewModel来处理，这时候Activity对应的ViewModel里面可能包含了两个Fragment各自的ViewModel，这就是嵌套的子ViewModel。还有另外一种就是对于AdapterView，如ListView RecyclerView、ViewPager等。  

//Child ViewModelpublic final 
ObservableList<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemViewModel</span><span class="token punctuation">></span></span> itemViewModel = new ObservableArrayList&lt;>();  

它们的每个Item其实就对应于一个ViewModel，然后在当前的ViewModel通过ObservableList持有引用（如上述代码），这也是很常见的嵌套的子ViewModel。我们其实还建议，如果一个页面业务非常复杂，不要把所有逻辑都写在一个ViewModel，可以把页面做业务划分，把不同的业务放到不同的ViewModel，然后整合到一个总的ViewModel，这样做起来可以使我们的代码业务清晰、简短意赅，也方便后人的维护。  

总的来说，ViewModel和View之前仅仅只有绑定的关系，View层需要的属性和事件处理都是在XML里面绑定好了，ViewModel层不会去操作UI，只是根据业务要求处理数据，这些数据自动映射到View层控件的属性上。关于ViewModel类中包含哪些模块和字段，这个需要开发者自己去衡量，我们建议ViewModel不要引入太多的成员变量，成员变量最好只有上面的提到的5种（context、model……），能不引入其他类型的变量就尽量不要引进来，太多的成员变量对于整个代码结构破坏很大，后面维护的人要时刻关心成员变量什么时候被初始化、什么时候被清掉、什么时候被赋值或者改变，一个细节不小心可能就出现潜在的Bug。太多不清晰定义的成员变量又没有注释的代码是很难维护的。

另外，我们会把UI控件的属性和事件都通过XML（如bind：text=@{...}）绑定。如果一个业务逻辑要弹一个Dialog，但是你又不想在ViewModel里面做弹窗的事（ViewModel不希望做UI相关的事）或者说改变ActionBar上面的图标的颜色，改变ActionBar按钮是否可点击，这些都不是写在XML里面（都是用Java代码初始化的），如何对这些控件的属性做绑定呢？我们先来看下代码  

public class MainViewModel implements ViewModel {
....
//true的时候弹出Dialog，false的时候关掉dialog
public final ObservableBoolean isShowDialog = new ObservableBoolean();
....
.....
}
// 在View层做一个对isShowDialog改变的监听
public class MainActivity extends RxBasePmsActivity {

private MainViewModel mainViewModel;

@Override
protected void onCreate(Bundle savedInstanceState) {
..... 
mainViewModel.isShowDialog.addOnPropertyChangedCallback(new android.databinding.Observable.OnPropertyChangedCallback() {
      @Override
      public void onPropertyChanged(android.databinding.Observable sender, int propertyId) {
          if (mainViewModel.isShowDialog.get()) {
               dialog.show();
          } else {
               dialog.dismiss();
          }
       }
    });
 }
 ...
}  

简单地说你可以对任意的ObservableField做监听，然后根据数据的变化做相应UI的改变，业务层ViewModel只要根据业务处理数据就行，以数据来驱动UI。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ViewModel与Model的协作"><a href="#ViewModel与Model的协作" class="headerlink" title="ViewModel与Model的协作"></a>ViewModel与Model的协作</h3><pre class="line-numbers language-html"><code class="language-html">从图1中，ViewModel通过传参数到Model层获取网络数据（数据库同理），然后把Model的部分数据映射到ViewModel的一些字段（ObservableField），并在ViewModel保留这个Model的引用，我们来看下这一块的大致代码（代码涉及简单的RxJava，如看不懂可以查阅入门一下）  

//Model
 private NewsDetail newsDetail;

 private void loadData(long id) {  
   //  Observable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Bean</span><span class="token punctuation">></span></span> 用来获取网络数据
   Observable&lt;Notification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NewsDetailService.NewsDetail</span><span class="token punctuation">></span></span>>   newsDetailOb =   
   RetrofitProvider.getInstance()
                  .create(NewsDetailService.class)   
                  .getNewsDetail(id)                   
                  .subscribeOn(Schedulers.io())      
                  .observeOn(AndroidSchedulers.mainThread())
                 // 将网络请求绑定到Activity 的生命周期
                  .compose(((ActivityLifecycleProvider) context).bindToLifecycle()) 
                 //变成 Notification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Bean</span><span class="token punctuation">></span></span> 使我们更方便处理数据和错误
                  .materialize().share();  

 // 处理返回的数据
   newsDetailOb.filter(Notification::isOnNext)         
               .map(n -> n.getValue())    
               // 给成员变量newsDetail 赋值，之前提到的5种变量类型中的一种（model类型）        
               .doOnNext(m -> newsDetail = m)   
               .subscribe(m -> initViewModelField(m));

 // 网络请求错误处理
    NewsListHelper.dealWithResponseError(
      newsDetailOb.filter(Notification::isOnError)        
                  .map(n -> n.getThrowable()));
}
//Model -->ViewModel
private void initViewModelField(NewsDetail newsDetail) {  
     viewStyle.isRefreshing.set(false);   
     imageUrl.set(newsDetail.getImage());    
     Observable.just(newsDetail.getBody())
            .map(s -> s + "&lt;style type=\"text/css\"><span class="token style language-css">" + newsDetail<span class="token number">.</span><span class="token function">getCssStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           
            <span class="token number">.</span><span class="token function">map</span><span class="token punctuation">(</span>s -> s + "</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>")            
            .subscribe(s -> html.set(s));   
     title.set(newsDetail.getTitle());
 }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们推荐MVVM和RxJava一块儿使用，虽然两者皆有观察者模式的概念，但是RxJava不使用在针对View的监听，更多是业务数据流的转换和处理。DataBinding框架其实是专用于View-ViewModel的动态绑定的，它使得我们的ViewModel只需要关注数据，而RxJava提供的强大数据流转换函数刚好可以用来处理ViewModel中的种种数据，得到很好的用武之地，同时加上Lambda表达式结合的链式编程，使ViewModel的代码非常简洁同时易读易懂。  </p>
<h3 id="ViewModel与ViewModel的协作"><a href="#ViewModel与ViewModel的协作" class="headerlink" title="ViewModel与ViewModel的协作"></a>ViewModel与ViewModel的协作</h3><p>在图1中我们看到两个ViewModel之间用一条虚线连接着，中间写着Messenger。Messenger可以理解是一个全局消息通道，引入Messenger最主要的目的是实现ViewModel和ViewModel的通信，虽然也可以用于View和ViewModel的通信，但并不推荐。ViewModel主要是用来处理业务和数据的，每个ViewModel都有相应的业务职责，但是在业务复杂的情况下，可能存在交叉业务，这时候就需要ViewModel和ViewModel交换数据和通信，这时候一个全局的消息通道就很重要。  </p>
<p>这里给出一个简单的例子仅供参考：场景是这样的，你的MainActivity对应一个MainViewModel，MainActivity 里面除了自己的内容还包含一个Fragment，这个Fragment 的业务处理对应于一个FragmentViewModel，FragmentViewModel请求服务器并获取数据。刚好这个数据MainViewModel也需要用到，我们不可能在MainViewModel重新请求数据，这样不太合理，这时候就需要把数据传给MainViewModel，那应该怎么传呢，如果彼此没有引用或者回调？那么只能通过全局的消息通道Messenger。  </p>
<p>FragmentViewModel获取消息后通知MainViewModel并把数据传给它  </p>
<pre class="line-numbers language-html"><code class="language-html">combineRequestOb.filter(Notification::isOnNext)        
.map(n -> n.getValue())        
.map(p -> p.first)        
.filter(m -> !m.getTop_stories().isEmpty())        
.doOnNext(m ->Observable.just(NewsListHelper.isTomorrow(date)).filter(b -> b).subscribe(b -> itemViewModel.clear())) 
// 上面的代码可以不看，就是获取网络数据 ，通过send把数据传过去
.subscribe(m -> Messenger.getDefault().send(m, TOKEN_TOP_NEWS_FINISH));  

MainViewModel接收消息并处理：  

Messenger.getDefault().register(activity, NewsViewModel.TOKEN_TOP_NEWS_FINISH, TopNewsService.News.class, (news) -> {
// to something....
}  

在MainActivity onDestroy取消注册就行了（不然导致内存泄露）：  

@Override
 protected void onDestroy() {    
      super.onDestroy();      
      Messenger.getDefault().unregister(this);
 }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="数据绑定实践"><a href="#数据绑定实践" class="headerlink" title="数据绑定实践"></a>数据绑定实践</h2><h3 id="单向数据绑定"><a href="#单向数据绑定" class="headerlink" title="单向数据绑定"></a>单向数据绑定</h3><ol>
<li>启用DataBinding,然后Sync Now  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">build.gradle (Module: 项目名.app)文件:
......
buildTypes{
    ......
}
......
//dataBinding{
//    enable=true
//} 或下面
buildFeatures{
    dataBinding true
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>修改布局文件为DataBinding布局<br>布局前6行之内，右键-&gt; show Context Actions-&gt; Convert to data binding layout</li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">使用<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span><span class="token punctuation">></span></span>标签来包装XML 布局。这样根类就不再是视图组，而是包含视图组和视图的布局。然后绑定对象可以识别出布局和其中的视图  

把传统的布局替换为dataBinding布局：在外层布局按住Ctrl+回车会提示是否转化成dataBinding布局，直接转化 
通常语法结构：
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name">...</span> <span class="token punctuation">></span></span>
   ...
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">></span></span>

Code->Reformat Code，格式化代码
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>进入MainActivity类创建绑定对象，替换setContentView  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">在onCreate()方法前为绑定对象创建一个变量。该变量通常称为binding。binding类型  
类名是布局文件名+Binding，布局文件首字母大写  
如ActivityMainBinding binding;  

点击ActivityMainBinding，按alt+Win导入缺失的类（Import class）
导入缺失类后添加对应的import语句  
用
binding = DataBindingUtil.setContentView(this, R.layout.activity_main);
替换之前的setContentView(R.layout.activity_main);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>使用绑定对象替换对findViewById()的所有调用  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">现在可以将对绑定对象中视图的引用替换为对findViewById()的所有调用  
如将findViewById<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">></span></span>(R.id.btn)替换为binding.btn，并添加要执行的操作代码

public class MainActivity extends AppCompatActivity {
    ActivityMainBinding binding;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding = DataBindingUtil.setContentView(this, R.layout.activity_main);
        binding.btn.setOnClickListener(this::clickHandlerFunction);
    }
    public void clickHandlerFunction(View view) {
        Toast.makeText(this,"你好", Toast.LENGTH_LONG).show();
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您在进行更改后看到编译器错误，请选择「构建（Build） &gt; 清理项目（Clean Project）」 ，然后选择「构建（Build）&gt; 重构项目（Rebuild Project）」。这样做通常会更新生成的文件。否则，选择「文件（File） &gt; 项目无效时缓存或重新启动（Invalidate Caches/Restart）」进行更彻底的清理。</p>
<p>总结，使用数据绑定替换对findViewById()的调用的步骤：  </p>
<pre class="line-numbers language-html"><code class="language-html">1. 在build.gradle (Module: 项目名.app)文件的android部分内启用数据绑定：buildFeatures { dataBinding true }
2. 在XML布局中使用<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span><span class="token punctuation">></span></span>作为根视图。
3. 定义绑定变量：ActivityMainBinding binding
4. 在MainActivity类内创建绑定对象，将setContentView(R.layout.activity_main)替换为binding = DataBindingUtil.setContentView(this, R.layout.activity_main)。
5. 用对绑定对象中视图ID属性值的引用替换对findViewById()的调用。例如：findViewById<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">></span></span>(R.id.btn)=>binding.btn，即在本例中，视图名是XML文件中的视图ID属性值「注意：以小驼峰式命名法（lower camel case）为准」。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="给xml布局绑定一个数据对象"><a href="#给xml布局绑定一个数据对象" class="headerlink" title="给xml布局绑定一个数据对象"></a>给xml布局绑定一个数据对象</h3><pre class="line-numbers language-html"><code class="language-html">1. 创建类MyAccount
package com.example.hiemptyactivity;
public class MyAccount {
    public String btnName="";
    public String textName="";
    public MyAccount(String bn,String tn){
        this.btnName=bn;
        this.textName=tn;
    }
}

2. MainActivity.java里添加被绑定的事件方法  
public void onClickHandler(View view){
    Toast.makeText(getApplicationContext(),"556677",Toast.LENGTH_SHORT).show();
}

3. 布局里添加变量和关联
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>variable</span>
        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>account<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.hiemptyactivity.MyAccount<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>variable</span>
        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>activity<span class="token punctuation">"</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.hiemptyactivity.MainActivity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>data</span><span class="token punctuation">></span></span>

4.给绑定变量赋值，从而改变ui的值，这是数据对UI的单向绑定  
package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import androidx.databinding.DataBindingUtil;
import android.os.Bundle;
import android.view.View;
import android.widget.Toast;
import com.example.hiemptyactivity.databinding.ActivityMainBinding;
public class MainActivity extends AppCompatActivity {
    ActivityMainBinding binding;
    MyAccount myAccount;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding= DataBindingUtil.setContentView(this,R.layout.activity_main);
        myAccount=new MyAccount("btn1","text2");
        binding.setAccount(myAccount);
        binding.setActivity(this);

    }
    public void onClickHandler(View view){
        Toast.makeText(getApplicationContext(),"556677",Toast.LENGTH_SHORT).show();
    }
}

5. 优化：当数据变化的时候，自动更新界面数据：  
a. 将绑定类继承BaseObservable。  
b. get方法添加@Bindable注解
c. set方法添加notifyPropertyChanged(BR.name);
package com.example.hiemptyactivity;
import androidx.databinding.BaseObservable;
import androidx.databinding.Bindable;
public class MyAccount extends BaseObservable {
    private String btnName="";
    private String textName="";
    public MyAccount(String bn,String tn){
        this.btnName=bn;
        this.textName=tn;
    }
    @Bindable
    public String getBtnName(){
        return btnName;
    }
    @Bindable
    public String getTextName(){
        return textName;
    }

    public void setBtnName(String btnName) {
        this.btnName = btnName;
        notifyPropertyChanged(BR.btnName);
    }
    public void setTextName(String textName){
        this.textName=textName;
        notifyPropertyChanged(BR.textName);
    }
}
经过上述步骤，上面的onClick方法就可以这么写：改变数据源以后会自动同步到界面上
public void onClickHandler(View view){
    Toast.makeText(getApplicationContext(),"556677",Toast.LENGTH_SHORT).show();
    myAccount.setBtnName("btn666");
    myAccount.setTextName("text999");
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="双向绑定"><a href="#双向绑定" class="headerlink" title="双向绑定"></a>双向绑定</h3><p>到目前为止都是单向绑定，数据更新以后会直接同步到界面上，在@后面加等号就是双向绑定了，一般用的比较多得是输入框  </p>
<pre class="line-numbers language-html"><code class="language-html">使用单向数据绑定时，您可以为特性设置值，并设置对该特性的变化作出反应的监听器：
android:id="@+id/rememberMeCheckBox"
android:checked="@{viewmodel.rememberMe}"
android:onCheckedChanged="@{viewmodel.rememberMeChanged}"
/>
UI&lt;==数据
双向数据绑定为此过程提供了一种快捷方式：
android:id="@+id/rememberMeCheckBox"
android:checked="@={viewmodel.rememberMe}"
/>
@={} 表示法(其中重要的是包含“=”符号)可接收属性的数据更改并同时监听用户更新。
UI&lt;==>数据
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="搭建MVVM实践"><a href="#搭建MVVM实践" class="headerlink" title="搭建MVVM实践"></a>搭建MVVM实践</h2><pre class="line-numbers language-html"><code class="language-html">ViewModelProcider.Factory：Factory用来生成ViewModel
ViewModel：持有LiveData，从Repository获取数据，并向View提供数据
Repository：获取和处理数据，可以从网络、数据库或其他API获取并处理数据
LiveData：具有生命周期感知能力的可观察的数据存储器，通知View展示数据

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初次搭建MVVM框架，主要目标是ViewModel 和 DataBinding。  </p>
<p>ViewModel 类旨在以注重生命周期的方式存储和管理界面相关的数据。ViewModel 类让数据可在发生屏幕旋转等配置更改后继续留存。  </p>
<p>DataBinding数据绑定库是一种支持库，借助该库，您可以使用声明性格式（而非程序化地）将布局中的界面组件绑定到应用中的数据源。  </p>
<ol>
<li>启用数据绑定，启用DataBinding，找到app模块下的build.gradle，在android{}闭包下添加如下代码,然后点击AS右上角的Sync Now进行工程配置同步 </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">buildFeatures {
    dataBinding true
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>而ViewModel不需要做什么就可以使用了。  </li>
</ol>
<h3 id="ViewModel的使用"><a href="#ViewModel的使用" class="headerlink" title="ViewModel的使用"></a>ViewModel的使用</h3><p>ViewModel的优势在于生命周期和数据持久化，那么它就适用于Activity和Fragment，其次就是异步回调，不会造成内存泄漏，再次就是对View层和Model层进行隔离，是两者不存在耦合性，因此你可以知道ViewModel在整个MVVM框架中的重要性了。  </p>
<h3 id="1-新建ViewModel类绑定activity"><a href="#1-新建ViewModel类绑定activity" class="headerlink" title="1.新建ViewModel类绑定activity"></a>1.新建ViewModel类绑定activity</h3><p>在MVVM的框架中，每一个Activity都应该对应一个ViewModel，而现在我们有一个MainActivity，因此可以新建一个viewmodels包，包下新建一个MainViewModel类</p>
<pre class="line-numbers language-html"><code class="language-html">public class MainViewModel extends ViewModel {
}
//注意这里要继承ViewModel，虽然现在里面什么都没有的，但后面使用的时候会进行增加
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>将viewmodel类与MainActivity进行绑定  </p>
<pre class="line-numbers language-html"><code class="language-html">回到MainActivity.java中，修改代码如下
package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.ViewModelProvider;
import android.os.Bundle;
public class MainActivity extends AppCompatActivity {
    MainViewModel mainViewModel;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        mainViewModel=new ViewModelProvider(this).get(MainViewModel.class);
    }
}  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：  </p>
<pre class="line-numbers language-html"><code class="language-html">mainViewModel = new ViewModelProvider(this).get(MainViewModel.class)；
可能这个"this"会爆红，
需要
需要在build.gradle（:app） 引入
   implementation 'com.google.android.material:material:1.0.0'
   implementation 'androidx.lifecycle:lifecycle-extensions:2.2.0'
然后sync proj同步工程
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我们的MainActivity和MainViewModel就绑定起来了。ViewModel是数据持久化的，因为对于一些变量就可以直接放在ViewModel当中，而不再放在Activity中，可以根据一个实际的需求来进行。  </p>
<h3 id="2-页面布局绘制和LiveData使用"><a href="#2-页面布局绘制和LiveData使用" class="headerlink" title="2.页面布局绘制和LiveData使用"></a>2.页面布局绘制和LiveData使用</h3><p>比如我现在有一个登录的功能要去实现,在ViewModel中定义两个变量  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;
public class MainViewModel extends ViewModel {
    public String account;
    public String pwd;

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改一下activity_main.xml中的布局，代码如下  </p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>padding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>32dp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.google.android.material.textfield.TextInputLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.google.android.material.textfield.TextInputEditText</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/et_account<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>hint</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>账号<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>com.google.android.material.textfield.TextInputLayout</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.google.android.material.textfield.TextInputLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginTop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>12dp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.google.android.material.textfield.TextInputEditText</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/et_pwd<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>hint</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>密码<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>inputType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>textPassword<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>com.google.android.material.textfield.TextInputLayout</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.google.android.material.button.MaterialButton</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/btn_login<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>48dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_margin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>24dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>insetTop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>insetBottom</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>登  录<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>cornerRadius</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>12dp<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span>

/*使用material.button.MaterialButton，需要将 android:theme="@style/AppTheme"  
中主题styles.xml中内容改为 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AppTheme<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Theme.MaterialComponents.NoActionBar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
*/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-实现登录"><a href="#3-实现登录" class="headerlink" title="3.实现登录"></a>3.实现登录</h3><p>MainActivity.java:  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.ViewModelProvider;
import android.os.Bundle;
import android.view.View;
import android.widget.Toast;
import com.google.android.material.textfield.TextInputEditText;
public class MainActivity extends AppCompatActivity {
    MainViewModel mainViewModel;
    private TextInputEditText etAccount,etPwd;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        mainViewModel=new ViewModelProvider(this).get(MainViewModel.class);

        etAccount=findViewById(R.id.et_account);
        etPwd=findViewById(R.id.et_pwd);
        findViewById(R.id.btn_login).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                mainViewModel.account=etAccount.getText().toString().trim();
                mainViewModel.pwd=etPwd.getText().toString().trim();
                if(mainViewModel.account.isEmpty()){
                    Toast.makeText(getApplicationContext(),"请输入账号",Toast.LENGTH_SHORT).show();
                    return;
                }
                if(mainViewModel.pwd.isEmpty()){
                    Toast.makeText(getApplicationContext(),"请输入密码",Toast.LENGTH_SHORT).show();
                    return;
                }
                Toast.makeText(getApplicationContext(),"登录成功",Toast.LENGTH_SHORT).show();
            }
        });
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>乍一看好像没啥不同的，无非就是给mainViewModel中的两个变量赋了值。不过这里有一个数据持久化的内容在里面  </p>
<p>手机在切换屏幕的时候Activity是会重新创建的，因此如果我们的数据是放在Activity中，那么切换屏幕之后就会重置，输入框也不会有值，但是通过ViewModel去保存输入框的值就不同了，虽然你的Activity在切换屏幕的时候销毁并且重新创建了，但是我的MainModel依然稳定，所以我才能在横屏的时候也登陆，这样不会造成数据丢失。</p>
<h3 id="1-可修改数据"><a href="#1-可修改数据" class="headerlink" title="1.可修改数据"></a>1.可修改数据</h3><p>LiveData是用来感知数据变化的,也就是说如果我一个页面中对一个TextView进行多次赋值的话，可以通过LiveData来操作，只需要在值改变的时候进行设置就好了，可以简化页面上的代码。下面举一个实际的例子来说明。依然是之前那个登录页面，不过需要修改一下MainViewModel中的变量，如下：  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;
public class MainViewModel extends ViewModel {
    public MutableLiveData<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> account = new MutableLiveData&lt;>();
    public MutableLiveData<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> pwd = new MutableLiveData&lt;>();
    //可修改数据
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-数据观察"><a href="#2-数据观察" class="headerlink" title="2.数据观察"></a>2.数据观察</h3><p>请注意这里使用的是MutableLiveData，表示值的内容开变动，而LiveData是不可变的。&lt;&gt;中的是泛型，你可以直接将一个对象放进去，当对象的内容有改动时，通知改变就可以了，现在这么写是为了方便理解。下面进入MainActivity中，首先我们改变一下布局activity_main.xml在按钮的下面再加如下代码  </p>
<pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/tv_account<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/tv_pwd<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后回到MainActivity中，修改代码如下图所示  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;

import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.Observer;
import androidx.lifecycle.ViewModelProvider;

import android.os.Bundle;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;

import com.google.android.material.textfield.TextInputEditText;

public class MainActivity extends AppCompatActivity {
    MainViewModel mainViewModel;
    private TextInputEditText etAccount,etPwd;
    private TextView tvAccount,tvPwd;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        mainViewModel=new ViewModelProvider(this).get(MainViewModel.class);

        etAccount=findViewById(R.id.et_account);
        etPwd=findViewById(R.id.et_pwd);
        tvAccount=findViewById(R.id.tv_account);
        tvPwd=findViewById(R.id.tv_pwd);
        findViewById(R.id.btn_login).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                mainViewModel.account.setValue(etAccount.getText().toString().trim());
                mainViewModel.pwd.setValue(etPwd.getText().toString().trim());
                if(mainViewModel.account.getValue().isEmpty()){
                    Toast.makeText(getApplicationContext(),"请输入账号",Toast.LENGTH_SHORT).show();
                    return;
                }
                if(mainViewModel.pwd.getValue().isEmpty()){
                    Toast.makeText(getApplicationContext(),"请输入密码",Toast.LENGTH_SHORT).show();
                    return;
                }
                Toast.makeText(getApplicationContext(),"登录成功",Toast.LENGTH_SHORT).show();
            }
        });
        mainViewModel.account.observe(this, new Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onChanged(String s) {
                tvAccount.setText("账号："+s);
            }
        });
        mainViewModel.pwd.observe(this, new Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onChanged(String s) {
                tvPwd.setText("密码："+s);
            }
        });
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先在给MainViewModel中的account赋值时，采用了MutableLiveData的setValue()的方式，还有一种方式是postValue()，这里要注意一点setValue()只能在主线程中调用，postValue()可以在任何线程中调用。pwd也是一样的，然后在最后一处标注的地方，对MainViewModel中的account和pwd进行数据观察</p>
<h3 id="DataBinding使用"><a href="#DataBinding使用" class="headerlink" title="DataBinding使用"></a>DataBinding使用</h3><p>Android的DataBinding在已经内置了，因此只需要在app模块的build.gradle中开启就可以使用了。DataBinding，顾名思义就是数据绑定，可以看到现在的三个组件都与数据有关系，ViewModel数据持有，LiveData数据观察、DataBinding数据绑定。</p>
<h2 id="RxJava实践"><a href="#RxJava实践" class="headerlink" title="RxJava实践"></a>RxJava实践</h2><p>RxJava采用的是观察者模式，代码结构是一个响应式链式编程。是一个可以控制线程操作线程的异步操作。  </p>
<p>观察者模式里面有三个身份，观察者(Observer)、被观察者(Observable)、订阅(Subscribe)。其中观察者代表警察，被观察者代表小偷，两者通过订阅联系在一起。指定了这个警察每天24小时专门观察这个小偷的一举一动，如果开始偷东西，便将其抓获。</p>
<pre class="line-numbers language-html"><code class="language-html">被观察者(Observable)通过create()方法创建一个subscribe()方法，里面有个参数ObservableEmitter，这个可以称之为发射器，这个发射器有三个方法。onNext()、onComplete()、onError()。  

onNext()：向Observe(观察者) onNext(Object s)方法中发射内容，观察者拿到这个内容之后可以随意操作。

onComplete():当observable(被观察者)将数据都发送完成之后就可以使用这个方法，代表结束。observer会在onComplete()中回调。我们可以将加载dialog的结束动效放在这个里面  

onError():顾名思义，当出现问题的时候回调这个方法。  

观察者和被观察者通过subscribe产生联系，即所谓的订阅。  

一般我们在使用的时候都是采用链式结构来使用：
 Observable.create(new ObservableOnSubscribe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void subscribe(ObservableEmitter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> e) throws Exception {
                //发射数据
                e.onNext("111");
                e.onNext("222");
                e.onNext("333");
                e.onComplete();
            }
        }).subscribe(new Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onSubscribe(Disposable d) {
                //初始化或者加载数据 
            }

            @Override
            public void onNext(String s) {
                Log.i("接受数据",s);
                Log.i("接受数据",s);
                Log.i("接受数据",s);

            }

            @Override
            public void onError(Throwable e) {

            }

            @Override
            public void onComplete() {
                Log.i("接收完成","finish");
            }
        });
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用RxJava可以轻松地实现线程切换，所以在Android中常被用来替代AsyncTask、Handler等原生工具类。  </p>
<pre class="line-numbers language-html"><code class="language-html">1. Scheduler:通过Scheduler让操作符跑在指定线程，从而实现多线程调度  
2. observerOn:指定一个观察者在哪个调度器上观察这个Observable  
3. subscribeOn:指定Observable自身在哪个调度器上执行  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>RxJava是一个在Java虚拟机上的响应式扩展，通过使用可观察的序列将异步和基于事件的程序组合起来的一个库。<br>它扩展了观察者模式来支持数据/事件序列，并且添加了操作符，这些操作符允许你声明性地组合序列，同时抽象出要关注的问题：比如低级线程、同步、线程安全和并发数据结构等。  </p>
<h3 id="添加依赖项"><a href="#添加依赖项" class="headerlink" title="添加依赖项"></a>添加依赖项</h3><pre class="line-numbers language-html"><code class="language-html">    implementation 'io.reactivex.rxjava2:rxjava:2.1.1'
    implementation 'io.reactivex.rxjava2:rxandroid:2.0.1'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Create完整的使用结构"><a href="#Create完整的使用结构" class="headerlink" title="Create完整的使用结构"></a>Create完整的使用结构</h3><p>使用 Create 操作符从头开始创建一个Observable，给这个操作符传递一个接受观察者作为参数的函数，编写这个函数可以调用观察者的 onNext，onError 和 onCompleted 方法，当发生订阅的时候会自动调用观察者的 onSubscribe 方法。  </p>
<p>通过 Subscribe 进行Observable 与 Observer 的订阅，其中 subscribe 方法可以接收一个完整通知参数的 Observer 对象，也可以接收部分通知参数的 Consumer(接收数据) 或者 Action (仅接收通知) 对象。</p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import io.reactivex.Observable;
import io.reactivex.ObservableEmitter;
import io.reactivex.ObservableOnSubscribe;
import io.reactivex.Observer;
import io.reactivex.disposables.Disposable;
import io.reactivex.functions.Action;
import io.reactivex.functions.Consumer;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        //创建被观察者Observable
        Observable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> observable=Observable.create(new ObservableOnSubscribe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void subscribe(ObservableEmitter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> e) throws Exception {
                e.onNext("HELLO");
                e.onNext("WORLD");
                e.onComplete();
            }
        });
        // 1 创建Observer(观察者), 可以接受所有通知
        Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> observer=new Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onSubscribe(Disposable d) {
                Log.d("tagXXXXXXXXXXX","--> onSubscribe");
            }
            @Override
            public void onNext(String s) {
                Log.d("tagXXXXXXXXXXX","--> onNext= "+s);
            }
            @Override
            public void onError(Throwable e) {
                Log.d("tagXXXXXXXXXXX","--> onError");
            }
            @Override
            public void onComplete() {
                Log.d("tagXXXXXXXXXXX","--> onComplete");
            }
        };
        // 1. 进行订阅，subscribe(Observer)
        observable.subscribe(observer);
        // 2 创建只接受 onNext(item) 通知的Consumer(观察者)
        Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> nextConsumer=new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(String s) throws Exception {
                Log.d("tagXXXXXXXXXXX","--> accept nextConsumer: "+s);
            }
        };
        // 2. 进行订阅，subscribe(Consumer onNext)
        observable.subscribe(nextConsumer);
        // 3 创建只接受 onError(Throwable) 通知的Consumer(观察者)
        Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Throwable</span><span class="token punctuation">></span></span> errorConsumer = new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Throwable</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(Throwable t) throws Exception {
                Log.d("tagXXXXXXXXXXX","-- accept errorConsumer: "+t);
            }
        };
        // 3. 进行订阅，subscribe(Consumer onNext, Consumer onError)
        observable.subscribe(nextConsumer, errorConsumer);
        // 4 创建只接受 onComplete() 通知的观察者
        Action completedAction=new Action() {
            @Override
            public void run() throws Exception {
                Log.d("tagXXXXXXXXXXX","-->  run completedAction ");
            }
        };
        // 4. 进行订阅，subscribe(Consumer onNext, Consumer onError, Action onCompleted)
        observable.subscribe(nextConsumer, errorConsumer, completedAction);
        // 5 创建只接受 onSubscribe 通知的Consumer(观察者)
        Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Disposable</span><span class="token punctuation">></span></span> onSubscribeComsumer = new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Disposable</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(Disposable t) throws Exception {
                Log.d("tagXXXXXXXXXXX","--> accept onSubscribeComsumer ");
            }
        };
        // 5. 进行订阅，subscribe(Consumer onNext, Consumer onError, Action onCompleted, Consumer onSubscribe)
        observable.subscribe(nextConsumer, errorConsumer, completedAction, onSubscribeComsumer);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Defer"><a href="#Defer" class="headerlink" title="Defer"></a>Defer</h3><p>直到有观察者订阅时才创建 Observable，并且为每个观察者创建一个新的 Observable.</p>
<p>Defer 操作符会一直等待直到有观察者订阅它，然后它使用Observable工厂方法生成一个 Observable。它对每个观察者都这样做，因此尽管每个订阅者都以为自己订阅的是同一个 Observable，事实上每个订阅者获取的是它们自己的单独的数据序列。  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;

import java.util.concurrent.Callable;

import io.reactivex.Observable;
import io.reactivex.ObservableEmitter;
import io.reactivex.ObservableOnSubscribe;
import io.reactivex.ObservableSource;
import io.reactivex.Observer;
import io.reactivex.disposables.Disposable;
import io.reactivex.functions.Action;
import io.reactivex.functions.Consumer;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // 创建一个Defer类型的Observable
        Observable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span> deferObservable=Observable.defer(new Callable&lt;ObservableSource<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>?</span> <span class="token attr-name">extends</span> <span class="token attr-name">Integer</span><span class="token punctuation">></span></span>>() {
            @Override
            public ObservableSource<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>?</span> <span class="token attr-name">extends</span> <span class="token attr-name">Integer</span><span class="token punctuation">></span></span> call() throws Exception {
//                return null;
                //创建每个观察者订阅所返回的Observable
                Observable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span> observable=Observable.create(new ObservableOnSubscribe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span>() {
                    @Override
                    public void subscribe(ObservableEmitter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span> e) throws Exception {
                        e.onNext(1);
                        e.onNext(2);
                        e.onNext(3);
                        e.onNext(4);
                        e.onComplete();
                    }
                });
                return observable;
            }
        });

        // 创建第一个观察者并订阅defer Observable
        deferObservable.subscribe(new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(Integer integer) throws Exception {
                Log.d("TAGXXXX","No.1 --> accept = "+String.valueOf(integer));
            }
        });
        // 创建第二个观察者并订阅defer Observable
        deferObservable.subscribe(new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(Integer integer) throws Exception {
                Log.d("TAGXXXX","No.2 --> accept = "+String.valueOf(integer));
            }
        });
        // 创建第三个观察者并订阅defer Observable
        deferObservable.subscribe(new Consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">></span></span>() {
            @Override
            public void accept(Integer integer) throws Exception {
                Log.d("TAGXXXX","No.3 --> accept = "+String.valueOf(integer));
            }
        });
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h3><h2 id="初识Retrofit"><a href="#初识Retrofit" class="headerlink" title="初识Retrofit"></a>初识Retrofit</h2><p>Retrofit 是一个 RESTful 的 HTTP 网络请求框架的封装。注意这里并没有说它是网络请求框架，主要原因在于网络请求的工作并不是 Retrofit 来完成的。Retrofit 2.0 开始内置 OkHttp，前者专注于接口的封装，后者专注于网络请求的高效，二者分工协作。  </p>
<p>应用程序通过 Retrofit 请求网络，实际上是使用 Retrofit 接口层封装请求参数、Header、Url 等信息，之后由 OkHttp 完成后续的请求操作，在服务端返回数据之后，OkHttp 将原始的结果交给 Retrofit，后者根据用户的需求对结果进行解析的过程。所谓 Retrofit，其实就是 Retrofitting OkHttp 。  </p>
<p>Retrofit通过一系列初始化配置之后，让我们可以通过注解的方式就能进行网络请求，很大程度上简化了我们在实际请求时所需要做的操作  </p>
<p>google在android p为了安全起见,已经明确规定禁止http协议额,但是之前很多接口都是http协议，我们一般是这样解决的：<br>在res目录下创建xml目录,然后随便创建一个network_security_config.xml文件,里面内容如下:  </p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在AndroidManifest.xml文件下加上:<br>android:networkSecurityConfig=”@xml/文件名”  </p>
<pre class="line-numbers language-html"><code class="language-html">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
&lt;application
...
    android:networkSecurityConfig="@xml/文件名"
    android:icon="@mipmap/ic_launcher"
    android:label="@string/app_name"
...
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hello-Retrofit"><a href="#hello-Retrofit" class="headerlink" title="hello Retrofit"></a>hello Retrofit</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><pre class="line-numbers language-html"><code class="language-html">implementation 'com.squareup.retrofit2:retrofit:2.0.2'  
implementation 'com.squareup.retrofit2:converter-scalars:2.0.0' //可无？
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="声明请求接口、初始化和权限"><a href="#声明请求接口、初始化和权限" class="headerlink" title="声明请求接口、初始化和权限"></a>声明请求接口、初始化和权限</h4><p>新建网络请求接口  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import retrofit2.Call;
import retrofit2.http.GET;
//所有网络请求接口
public interface INetWorkService {
    /**
    * 一个get请求的请求接口,返回是字符串
    * @return
    */
    @GET("https://publicobject.com/helloworld.txt")
    public Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> get();
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编写MyApp继承Application,别忘了在项目清单文件中的application节点中添加name属性,并且添加网络请求的权限  </p>
<pre class="line-numbers language-html"><code class="language-html">//MyApp.java:  
package com.example.hiemptyactivity;
import android.app.Application;
import retrofit2.Retrofit;
import retrofit2.converter.scalars.ScalarsConverterFactory;
public class MyApp extends Application {
    //声明请求的接口
    public static INetWorkService netWorkService;
    //网络请求框架
    public static Retrofit retrofit;
    @Override
    public void onCreate() {
        super.onCreate();
        retrofit=new Retrofit.Builder()
                .baseUrl("http://192.168.1.102:8080/Retrofit/")
                .addConverterFactory(ScalarsConverterFactory.create())
                .build();
        //让框架自动实现我们的请求接口,让我们声明的网络请求接口可以被调用
        netWorkService=retrofit.create(INetWorkService.class);
    }
}



//AndroidManifest.xml:  
<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.hiemptyactivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MyApp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建了初始化了请求的接口,并且添加了一个转化器,这样子在任何地方就可以直接使用了</p>
<p>并且可以看到我们有一个baseUrl,这是相当于前缀的意思,如果你请求的地址不是绝对的,那么他会添加上这个前缀,如果你的请求是绝对的地址,那么这个baseUrl就会被自动忽略  </p>
<h4 id="使用网络请求"><a href="#使用网络请求" class="headerlink" title="使用网络请求"></a>使用网络请求</h4><pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import java.io.File;
import okhttp3.MediaType;
import okhttp3.RequestBody;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        Button btn1=findViewById(R.id.button1);
        btn1.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
//                getTest(view);
                testpostdata(view);
            }
        });
    }
    public void getTest(View view){
        Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call =MyApp.netWorkService.get();
        call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> response) {
                String result=response.body();
                Log.d("xxxx",result);
                //{"code":200,"message":"Succeed","data":{"versionCode":"1.0.5","fileName":"abc-20221128.apk"}}
                try {
                    JSONObject jObject=new JSONObject(result);
                    Object obj_code=jObject.get("code");
                    Object obj_data= jObject.get("data");
                    JSONObject jObject_data=new JSONObject(obj_data.toString());
                    Log.d("xxxxxxx",jObject_data.get("fileName").toString());
                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Throwable t) {
                Log.d("xxxx","请求失败");
            }
        });
    }
    public void testpostdata(View view){
        Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call = MyApp.netWorkService.registerPostData("name1","pass1");
        call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> response) {
                String result=response.body();
                Log.d("xxxx",result);

            }
            @Override
            public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Throwable t) {
                Log.d("xxxx","请求失败");
            }
        });
    }

    public void postFile(View v) {
        //需要上传的文件
        File f = new File(Environment.getExternalStorageDirectory(), "address.db");

        //创建文件部分的请求体对象
        RequestBody fileBody = RequestBody.create(MediaType.parse("application/octet-stream"), f);

        //普通键值对的请求体
        RequestBody nameBody = RequestBody.create(null,"小金子");
        RequestBody passBody = RequestBody.create(null,"123");

        Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call = MyApp.netWorkService.postFile(fileBody, nameBody, passBody);

        call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
            @Override
            public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> response) {

                System.out.println("上传成功" + response.body() + response.code() + response.errorBody());

            }

            @Override
            public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> call, Throwable t) {
                System.out.println("上传文件失败");
            }
        });

    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="rxjava-retrofit获取数据"><a href="#rxjava-retrofit获取数据" class="headerlink" title="rxjava+retrofit获取数据"></a>rxjava+retrofit获取数据</h3><pre class="line-numbers language-html"><code class="language-html">/**
     * 使用rx+retrofit获取数据
     * 【subscribeOn和observeOn区别】
     * 1、subscribeOn用于切换之前的线程
     * 2、observeOn用于切换之后的线程
     * 3、observeOn之后，不可再调用subscribeOn切换线程
     * ———————— 额外总结 ————————————
     * 1、下面提到的“操作”包括产生事件、用操作符操作事件以及最终的通过 subscriber 消费事件
     * 2、只有第一subscribeOn() 起作用（所以多个 subscribeOn() 毛意义）
     * 3、这个 subscribeOn() 控制从流程开始的第一个操作，直到遇到第一个 observeOn()
     * 4、observeOn() 可以使用多次，每个 observeOn() 将导致一次线程切换()，这次切换开始于这次 observeOn() 的下一个操作
     * 5、不论是 subscribeOn() 还是 observeOn()，每次线程切换如果不受到下一个 observeOn() 的干预，线程将不再改变，不会自动切换到其他线程
     *
     * @param view
     */
    public void btnClick1(View view) {
        Retrofit retrofit = new Retrofit.Builder()
                .baseUrl(Consts.APP_HOST)
                .addConverterFactory(GsonConverterFactory.create())
                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())
                .build();
        ApiService apiService = retrofit.create(ApiService.class);
        Observable&lt;BaseResponse&lt;List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserModel</span><span class="token punctuation">></span></span>>> observable = apiService.getUsersByRx();
        observable
                .subscribeOn(Schedulers.io())  // 网络请求切换在io线程中调用
                .unsubscribeOn(Schedulers.io())// 取消网络请求放在io线程
                .observeOn(AndroidSchedulers.mainThread())// 观察后放在主线程调用
                .subscribe(new Subscriber&lt;BaseResponse&lt;List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserModel</span><span class="token punctuation">></span></span>>>() {
                    @Override
                    public void onCompleted() {

                    }

                    @Override
                    public void onError(Throwable e) {
                        showToast("rx失败:" + e.getMessage());
                        Log.e(TAG, "rx失败:" + e.getMessage());
                        mTextView.setText("rx失败:" + e.getMessage());
                    }

                    @Override
                    public void onNext(BaseResponse&lt;List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserModel</span><span class="token punctuation">></span></span>> listBaseResponse) {
                        showToast("rx成功:" + listBaseResponse.data.toString());
                        mTextView.setText("rx成功:" + listBaseResponse.data.toString());
                        Log.e(TAG, "rx成功:" + listBaseResponse.data.toString());
                    }
                });
    }
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Retrofit对象和请求框架"><a href="#Retrofit对象和请求框架" class="headerlink" title="Retrofit对象和请求框架"></a>Retrofit对象和请求框架</h3><p>定义回调: 封装的框架让使用者传递一个回调的对象，在网络请求开始、结束、异常等阶段根据需要将调用相应的回调接口。<br>该回调接口还能够自动处理一些网络异常，并给予相应的提示（按需修改）。   </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 网络请求结果处理类
 * @param <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> 请求结果封装对象
 */
public static abstract class ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> {
    Context context;

    public ResultHandler(Context context) {
        this.context = context;
    }

    /**
     * 判断网络是否未连接
     *
     * @return
     */
    public boolean isNetDisconnected() {
        return NetworkUtil.isNetDisconnected(context);
    }

    /**
     * 请求成功之前
     */
    public abstract void onBeforeResult();

    /**
     * 请求成功时
     *
     * @param t 结果数据
     */
    public abstract void onResult(T t);

    /**
     * 服务器出错
     */
    public void onServerError() {
        // 服务器处理出错
        Toast.makeText(context, R.string.net_server_error, Toast.LENGTH_SHORT).show();
    }

    /**
     * 请求失败后的处理
     */
    public abstract void onAfterFailure();

    /**
     * 请求失败时的处理
     *
     * @param t
     */
    public void onFailure(Throwable t) {
        if (t instanceof SocketTimeoutException || t instanceof ConnectException) {
            // 连接异常
            if (NetworkUtil.isNetworkConnected(context)) {
                // 服务器连接出错
                Toast.makeText(context, R.string.net_server_connected_error, Toast.LENGTH_SHORT).show();
            } else {
                // 手机网络不通
                Toast.makeText(context, R.string.net_not_connected, Toast.LENGTH_SHORT).show();
            }
        } else if (t instanceof Exception) {
            // 功能异常
            Toast.makeText(context, R.string.net_unknown_error, Toast.LENGTH_SHORT).show();
        }
    }
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中的string定义：  </p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_not_connected<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发送请求失败，请检查网络连接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_server_connected_error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>连接服务器失败，请稍后重试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_server_error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>服务器处理请求失败，请稍后重试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_server_param_error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>应用数据出错，请刷新重试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_unknown_error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>未知错误，请稍后重试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Get请求"><a href="#Get请求" class="headerlink" title="Get请求"></a>Get请求</h4><p>Retrofit通过定义service来发起网络请求服务，Get请求服务可以定义为  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.dommy.retrofitframe.network;

import okhttp3.ResponseBody;
import retrofit2.Call;
import retrofit2.http.GET;
import retrofit2.http.Url;

/**
 * Get请求封装
 */
public interface GetRequest {

    /**
     * 发送Get请求请求
     * @param url URL路径
     * @return
     */
    @GET
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> getUrl(@Url String url);
}

// 需要加@GET注解；
// url对应的参数需要加@Url注解。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>封装get请求方法,定义static方法：  </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 发送GET网络请求
 * @param url 请求地址
 * @param clazz 返回的数据类型
 * @param resultHandler 回调
 * @param <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> 泛型
 */
public static <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">extends</span> <span class="token attr-name">BaseResult</span><span class="token punctuation">></span></span> void sendGetRequest(String url, final Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> clazz, final ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> resultHandler) {
    // 判断网络连接状况
    if (resultHandler.isNetDisconnected()) {
        resultHandler.onAfterFailure();
        return;
    }

    GetRequest getRequest = retrofit.create(GetRequest.class);

    // 构建请求
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call = getRequest.getUrl(url);
    call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span>() {
        @Override
        public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> response) {
            resultHandler.onBeforeResult();
            try {
                ResponseBody body = response.body();
                if (body == null) {
                    resultHandler.onServerError();
                    return;
                }
                String string = body.string();
                T t = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create().fromJson(string, clazz);

                resultHandler.onResult(t);
            } catch (IOException e) {
                e.printStackTrace();
                resultHandler.onFailure(e);
            }
        }

        @Override
        public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Throwable t) {
            resultHandler.onFailure(t);
            resultHandler.onAfterFailure();
        }
    });
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发起Get请求  </p>
<pre class="line-numbers language-html"><code class="language-html">RetrofitRequest.sendGetRequest(url, WeatherResult.class, new RetrofitRequest.ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WeatherResult</span><span class="token punctuation">></span></span>(this) {
    @Override
    public void onBeforeResult() {
        // 这里可以放关闭loading
    }

    @Override
    public void onResult(WeatherResult weatherResult) {
        String weather = new Gson().toJson(weatherResult);
        tvContent.setText(weather);
    }

    @Override
    public void onAfterFailure() {
        // 这里可以放关闭loading
    }
});
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，WeatherResult类  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.dommy.retrofitframe.network.result;

import com.google.gson.JsonObject;

public class WeatherResult extends BaseResult {
    private int code;
    private String msg;
    private JsonObject data; // 数据部分也是一个bean，用JsonObject代替了

    public int getCode() {
        return code;
    }

    public void setCode(int code) {
        this.code = code;
    }

    public String getMsg() {
        return msg;
    }

    public void setMsg(String msg) {
        this.msg = msg;
    }

    public JsonObject getData() {
        return data;
    }

    public void setData(JsonObject data) {
        this.data = data;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Post请求"><a href="#Post请求" class="headerlink" title="Post请求"></a>Post请求</h4><p>定义PostRequest,Post请求服务可以定义为  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.dommy.retrofitframe.network;

import java.util.Map;

import okhttp3.ResponseBody;
import retrofit2.Call;
import retrofit2.http.FieldMap;
import retrofit2.http.FormUrlEncoded;
import retrofit2.http.POST;
import retrofit2.http.Url;

/**
 * Post请求封装
 */
public interface PostRequest{

    /**
     * 发送Post请求
     * @param url URL路径
     * @param requestMap 请求参数
     * @return
     */
    @FormUrlEncoded
    @POST
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> postMap(@Url String url, @FieldMap Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">String</span><span class="token punctuation">></span></span> requestMap);
}

// 需要加@FormUrlEncoded、@POST注解；
// url对应的参数需要加@Url注解。
// post提交的参数需要加@FieldMap注解。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>封装post请求方法,定义static方法  </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 发送post网络请求
 * @param url 请求地址
 * @param paramMap 参数列表
 * @param clazz 返回的数据类型
 * @param resultHandler 回调
 * @param <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> 泛型
 */
public static <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">extends</span> <span class="token attr-name">BaseResult</span><span class="token punctuation">></span></span> void sendPostRequest(String url, Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">String</span><span class="token punctuation">></span></span> paramMap, final Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> clazz, final ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> resultHandler) {
    // 判断网络连接状况
    if (resultHandler.isNetDisconnected()) {
        resultHandler.onAfterFailure();
        return;
    }
    PostRequest postRequest = retrofit.create(PostRequest.class);

    // 构建请求
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call = postRequest.postMap(url, paramMap);
    call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span>() {
        @Override
        public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> response) {
            resultHandler.onBeforeResult();
            try {
                ResponseBody body = response.body();
                if (body == null) {
                    resultHandler.onServerError();
                    return;
                }
                String string = body.string();
                T t = new Gson().fromJson(string, clazz);

                resultHandler.onResult(t);
            } catch (IOException e) {
                e.printStackTrace();
                resultHandler.onFailure(e);
            }
        }

        @Override
        public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Throwable t) {
            resultHandler.onFailure(t);
            resultHandler.onAfterFailure();
        }
    });
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发起Post请求  </p>
<pre class="line-numbers language-html"><code class="language-html">RetrofitRequest.sendPostRequest(url, paramMap, WeatherResult.class, new RetrofitRequest.ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WeatherResult</span><span class="token punctuation">></span></span>(this) {
    @Override
    public void onBeforeResult() {
        // 这里可以放关闭loading
    }

    @Override
    public void onResult(WeatherResult weatherResult) {
        String weather = new Gson().toJson(weatherResult);
        tvContent.setText(weather);
    }

    @Override
    public void onAfterFailure() {
        // 这里可以放关闭loading
    }
});

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p>定义FileRequest  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.dommy.retrofitframe.network;

import java.util.Map;

import okhttp3.RequestBody;
import okhttp3.ResponseBody;
import retrofit2.Call;
import retrofit2.http.GET;
import retrofit2.http.Multipart;
import retrofit2.http.POST;
import retrofit2.http.PartMap;
import retrofit2.http.Streaming;
import retrofit2.http.Url;

/**
 * 文件上传请求封装
 */
public interface FileRequest {

    /**
     * 上传文件请求
     * @param url      URL路径
     * @param paramMap 请求参数
     * @return
     */
    @Multipart
    @POST
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> postFile(@Url String url, @PartMap Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">RequestBody</span><span class="token punctuation">></span></span> paramMap);

    /**
     * 下载文件get请求
     * @param url 链接地址
     * @return
     */
    @Streaming
    @GET
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> download(@Url String url);
}

// 文件上传需要额外添加@Multipart、@PartMap注解；
// 文件下载需要额外添加@Streaming注解。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>封装文件上传方法,定义static方法：  </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 发送上传文件网络请求
 * @param url 请求地址
 * @param file 文件
 * @param clazz 返回的数据类型
 * @param resultHandler 回调
 * @param <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> 泛型
 */
public static <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">extends</span> <span class="token attr-name">BaseResult</span><span class="token punctuation">></span></span> void fileUpload(String url, File file, final Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> clazz, final ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span> resultHandler) {
    // 判断网络连接状况
    if (resultHandler.isNetDisconnected()) {
        resultHandler.onAfterFailure();
        return;
    }
    FileRequest fileRequest = retrofit.create(FileRequest.class);

    Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">RequestBody</span><span class="token punctuation">></span></span> paramMap = new HashMap&lt;>();
    addMultiPart(paramMap, "file", file);

    // 构建请求
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call = fileRequest.postFile(url, paramMap);
    call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span>() {
        @Override
        public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> response) {
            resultHandler.onBeforeResult();
            try {
                ResponseBody body = response.body();
                if (body == null) {
                    resultHandler.onServerError();
                    return;
                }
                String string = body.string();
                T t = new Gson().fromJson(string, clazz);

                resultHandler.onResult(t);
            } catch (IOException e) {
                e.printStackTrace();
                resultHandler.onFailure(e);
            }
        }

        @Override
        public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Throwable t) {
            resultHandler.onFailure(t);
            resultHandler.onAfterFailure();
        }
    });
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发起文件上传请求：因为没有找到现成的上传文件接口，所以这里就随便弄了个接口做了个例子。自己写的时候在后台做一个接口文件的接口就行了  </p>
<pre class="line-numbers language-html"><code class="language-html">File file = null;
try {
    // 通过新建文件替代文件寻址
    file = File.createTempFile("abc", "txt");
} catch (IOException e) {
}
String url = Constant.URL_LOGIN;
RetrofitRequest.fileUpload(url, file, BaseResult.class, new RetrofitRequest.ResultHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BaseResult</span><span class="token punctuation">></span></span>(this) {
    @Override
    public void onBeforeResult() {
        // 这里可以放关闭loading
    }

    @Override
    public void onResult(BaseResult baseResult) {
        tvContent.setText("上传成功");
    }

    @Override
    public void onAfterFailure() {
        // 这里可以放关闭loading
    }
});
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h4><p>基于FileRequest的定义，封装fileDownload方法即可<br>定义DownloadHandler<br>因为文件下载过程中涉及到进度的计算、显示，所以这里需要定义一个DownloadHandler回调  </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 文件下载回调
 */
public interface DownloadHandler {
    /**
     * 接收到数据体
     * @param body 响应体
     */
    public void onBody(ResponseBody body);

    /**
     * 文件下载出错
     */
    public void onError();
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义Retrofit对象<br>为了防止回调方法内部涉及到界面操作，出现NetworkOnMainThreadException问题，特别自定义一个回调方法执行器executorService  </p>
<pre class="line-numbers language-html"><code class="language-html">ExecutorService executorService = Executors.newFixedThreadPool(1);
// 网络框架
Retrofit retrofit = new Retrofit.Builder()
        .baseUrl(Constant.URL_BASE)
        .callbackExecutor(executorService)
        .build();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>封装文件下载方法  </p>
<pre class="line-numbers language-html"><code class="language-html">/**
 * 文件下载
 * @param url 请求地址
 * @param downloadHandler 回调接口
 */
public static void fileDownload(String url, final DownloadHandler downloadHandler) {
    // 回调方法执行器，定义回调在子线程中执行，避免Callback返回到MainThread，导致文件下载出现NetworkOnMainThreadException
    ExecutorService executorService = Executors.newFixedThreadPool(1);
    // 网络框架
    Retrofit retrofit = new Retrofit.Builder()
            .baseUrl(Constant.URL_BASE)
            .callbackExecutor(executorService)
            .build();

    FileRequest fileRequest = retrofit.create(FileRequest.class);
    // 构建请求
    Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call = fileRequest.download(url);
    call.enqueue(new Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span>() {
        @Override
        public void onResponse(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Response<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> response) {
            if (response.isSuccessful()) {
                // 写入文件
                downloadHandler.onBody(response.body());
            } else {
                downloadHandler.onError();
            }
        }

        @Override
        public void onFailure(Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResponseBody</span><span class="token punctuation">></span></span> call, Throwable t) {
            downloadHandler.onError();
        }
    });
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件下载示例  </p>
<pre class="line-numbers language-html"><code class="language-html">RetrofitRequest.fileDownload(Constant.URL_DOWNLOAD, new RetrofitRequest.DownloadHandler() {
    @Override
    public void onBody(ResponseBody body) {
        if (!writeResponseBodyToDisk(body)) {
            mHandler.sendEmptyMessage(DOWNLOAD_ERROR);
        }
    }

    @Override
    public void onError() {
        mHandler.sendEmptyMessage(DOWNLOAD_ERROR);
    }
});
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中涉及到的对象和方法：  </p>
<pre class="line-numbers language-html"><code class="language-html">private static final int DOWNLOAD_ING = 1;// 下载中
private static final int DOWNLOAD_FINISH = 2;// 下载结束
private static final int DOWNLOAD_ERROR = -1;// 下载出错

private Handler mHandler = new Handler() {
    @Override
    public void handleMessage(Message msg) {
        switch (msg.what) {
            case DOWNLOAD_ING:
                // 正在下载
                showProgress();
                break;
            case DOWNLOAD_FINISH:
                // 下载完成
                onDownloadFinish();
                break;
            case DOWNLOAD_ERROR:
                // 出错
                onDownloadError();
                break;
        }
    }
};

/**
 * 写文件入磁盘
 *
 * @param body 请求结果
 * @return boolean 是否下载写入成功
 */
private boolean writeResponseBodyToDisk(ResponseBody body) {
    savePath = StorageUtil.getDownloadPath();
    File apkFile = new File(savePath, fileName);
    InputStream inputStream = null;
    OutputStream outputStream = null;
    try {
        byte[] fileReader = new byte[4096];
        // 获取文件大小
        long fileSize = body.contentLength();
        long fileSizeDownloaded = 0;
        inputStream = body.byteStream();
        outputStream = new FileOutputStream(apkFile);

        // byte转Kbyte
        BigDecimal bd1024 = new BigDecimal(1024);
        totalByte = new BigDecimal(fileSize).divide(bd1024, BigDecimal.ROUND_HALF_UP).setScale(0).intValue();

        // 只要没有取消就一直下载数据
        while (!cancelUpdate) {
            int read = inputStream.read(fileReader);
            if (read == -1) {
                // 下载完成
                mHandler.sendEmptyMessage(DOWNLOAD_FINISH);
                break;
            }
            outputStream.write(fileReader, 0, read);
            fileSizeDownloaded += read;
            // 计算进度
            progress = (int) (((float) (fileSizeDownloaded * 100.0 / fileSize)));
            downByte = new BigDecimal(fileSizeDownloaded).divide(bd1024, BigDecimal.ROUND_HALF_UP).setScale(0).intValue();
            // 子线程中，借助handler更新界面
            mHandler.sendEmptyMessage(DOWNLOAD_ING);
        }
        outputStream.flush();
        return true;
    } catch (Exception e) {
        e.printStackTrace();
        return false;
    } finally {
        if (outputStream != null) {
            try {
                outputStream.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        if (inputStream != null) {
            try {
                inputStream.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}

/**
 * 显示下载进度
 */
private void showProgress() {
    String text = progress + "%  |  " + downByte + "Kb / " + totalByte + "Kb";
    tvContent.setText(text);
}

/**
 * 下载出错处理
 */
private void onDownloadError() {
    tvContent.setText("下载出错");
}

/**
 * 下载完成
 */
private void onDownloadFinish() {
    tvContent.setText("下载已完成");
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Retrofit框架在APP中具有出现的性能，鉴于API的调用相对复杂（容易冗余），特封装了一套框架来支持日常开发使用。开发者可根据自身需要定义回调接口包含的方法，裁切部分功能。  </p>
<h2 id="Gson"><a href="#Gson" class="headerlink" title="Gson"></a>Gson</h2><p>Gradle导入  </p>
<pre class="line-numbers language-html"><code class="language-html">implementation 'com.google.code.gson:gson:2.9.0'
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Gson的应用主要为toJson与fromJson两个转换函数，无依赖，不需要例外额外的jar，能够直接跑在JDK上。而在使用这种对象转换之前需先创建好对象的类型以及其成员才能成功的将JSON字符串成功转换成相对应的对象。<br>类里面只要有get和set方法，Gson完全可以将复杂类型的json到bean或bean到json的转换，是JSON解析的神器。  </p>
<blockquote>
<p>新建bean    </p>
</blockquote>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
public class Person {
    private String name="";
    private int age=0;
    public Person(){};
    public void setName(String name) {
        this.name = name;
    }
    public void setAge(int age){
        this.age=age;
    }
    public String getName(){
        return this.name;
    }
    public int getAge(){
        return this.age;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>基本使用    </p>
</blockquote>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import java.util.ArrayList;
import java.util.List;
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
//序列化toJason：List 对象 --> Json字符串
        Gson gson=new Gson();
        List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Person</span><span class="token punctuation">></span></span> persons=new ArrayList<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Person</span><span class="token punctuation">></span></span>();
        for(int i=0;i&lt;10;i++){
            Person p = new Person();
            p.setName("name"+i);
            p.setAge(i*5);
            persons.add(p);
        }
        String str = gson.toJson(persons);
        Log.d("xxxxx",str);

//反序列化fromJson：解析Json字符串  --> List对象
        List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Person</span><span class="token punctuation">></span></span> ps=gson.fromJson(str,new TypeToken&lt;List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Person</span><span class="token punctuation">></span></span>>(){}.getType());
        for(int i=0;i&lt;ps.size();i++){
            Person p=ps.get(i);
            Log.d("ddddd",p.getName()+"  "+p.getAge());
        }

        //Entity JavaBean --> Json字符串
        Person p2 = new Person();
        p2.setName("namexx");
        p2.setAge(66);
        persons.add(p2);
        String str2 = gson.toJson(p2);
        Log.d("yyyy",str2);
        //Json字符串 --> Entity JavaBean
        Person person = gson.fromJson(str2, Person.class);
        Log.d("yyyy",person.getName()+"  "+person.getAge());


    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ARouter路由框架"><a href="#ARouter路由框架" class="headerlink" title="ARouter路由框架"></a>ARouter路由框架</h2><pre class="line-numbers language-html"><code class="language-html">题外话： implementation 和 api 关键字，在Android studio3.0版本中，曾经的 compile 关键字被弃用，而 api 则是 compile 的替代品， api 与 compile 没有区别。但最新官方推荐使用 implementation 来代替 compile 关键字，据说 implementation 会使Android studio的编译速度更快呦。

而 implementation 和 api 关键字的区别则在于用 implementation 来声明的依赖包只限于当前module内部使用，对于依赖其module的模块是无法使用到该依赖包的。而用 api 来声明依赖包时，依赖于该module的模块可以正常使用其模块内的依赖包。

在这里，由于我是将其放入一个公共的module，来让app module进行依赖，因此使用 api 关键字。若没有对项目进行组件化，则可以使用 implementation 关键字进行依赖。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加依赖和设置"><a href="#添加依赖和设置" class="headerlink" title="添加依赖和设置"></a>添加依赖和设置</h3><p>在需要集成的module中添加依赖和配置  </p>
<pre class="line-numbers language-html"><code class="language-html">android {
    defaultConfig {
        ...
        javaCompileOptions {
            annotationProcessorOptions {
                arguments = [moduleName :project.getName() ]
            } 
        }       
        ...
}

dependencies {
    api 'com.alibaba:arouter-api:1.3.1'
    annotationProcessor 'com.alibaba:arouter-compiler:1.1.4'
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在项目build.gradle开启混淆  </p>
<pre class="line-numbers language-html"><code class="language-html">buildTypes{
    debug{
        minifyEnabled false
        proguardFiles getDefaultProguardFile('proguard-android.txt'),'proguard-rules.pro'
    }
    release{
        minifyEnabled true
        proguardFiles getDefaultProguardFile('proguard-android.txt'),'proguard-rules.pro'
    }

}  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加混淆规则（proguard-rules.pro文件在资源管理器里查看，与build.gradle同级，位于app/下）  </p>
<pre class="line-numbers language-html"><code class="language-html">#ARouter
-keep public class com.alibaba.android.arouter.routes.**{*;}
-keep public class com.alibaba.android.arouter.facade.**{*;}
-keep class * implements com.alibaba.android.arouter.facade.template.ISyringe{*;}

# If you use the byType method to obtain Service, add the following rules to protect the interface:
-keep interface * implements com.alibaba.android.arouter.facade.template.IProvider

# If single-type injection is used, that is, no interface is defined to implement IProvider, the following rules need to be added to protect the implementation
# -keep class * implements com.alibaba.android.arouter.facade.template.IProvider
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="初始化路由框架"><a href="#初始化路由框架" class="headerlink" title="初始化路由框架"></a>初始化路由框架</h3><pre class="line-numbers language-html"><code class="language-html">&lt;application
        android:name=".MyApp"

package com.example.hiemptyactivity;
import android.app.Application;
import android.util.Log;
import com.alibaba.android.arouter.launcher.ARouter;
public class MyApp extends Application {
    private boolean isDebugARouter=true;
    @Override
    public void onCreate() {
        super.onCreate();
        if(isDebugARouter){
            //下面两行必须写在init之前，否则这些配置在init中将无效
            ARouter.openLog();
            //开启调试模式（如果在InstantRun模式下运行，必须开启调试模式！
            // 线上版本需要关闭，否则有安全风险）
            ARouter.openDebug();
        }
        //官方推荐放到Application中初始化
        ARouter.init(this);
        Log.d("xxxx","ARouter init success");

    }
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="简单跳转"><a href="#简单跳转" class="headerlink" title="简单跳转"></a>简单跳转</h3><pre class="line-numbers language-html"><code class="language-html">@Route(path="/path/bactivity")
class BActivity:AppCompatActivity(){

}
......  

1. path跳转：用注解标记字符串标记目标activity，通过调用navigaation方法跳转到目标activity  
ARouter.getInstance().build("/path/bactivity").navigation();
2. Uri跳转：  
ARouter.getInstance().build(Uri.parse("/path/bactivity")).navigation();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="路径统一管理"><a href="#路径统一管理" class="headerlink" title="路径统一管理"></a>路径统一管理</h3><pre class="line-numbers language-html"><code class="language-html">public class ARouterConstants {
  //路径必须要最少是/xx/xx
    public static final String ACTIVITY_URL_LOGIN= "/app/LoginActivity";
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="增加注解"><a href="#增加注解" class="headerlink" title="增加注解"></a>增加注解</h3><pre class="line-numbers language-html"><code class="language-html">//使用该注解，并且指明path。
@Route(path = ARouterConstants.ACTIVITY_URL_LOGIN)
public class LoginActivity extends AppCompatActivity{
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="发起路由操作"><a href="#发起路由操作" class="headerlink" title="发起路由操作"></a>发起路由操作</h3><p>直接跳转或者携带参数  </p>
<pre class="line-numbers language-html"><code class="language-html">// 1. 应用内简单的跳转(通过URL跳转在'进阶用法'中)
ARouter.getInstance().build(ARouterConstants.ACTIVITY_URL_LOGIN).navigation();

// 2. 跳转并携带参数
ARouter.getInstance().build(ARouterConstants.ACTIVITY_URL_LOGIN)
                        .withLong("key1", 666L)
                        .withString("key2", "888")
                        .withSerializable("key3", new ProfileBean())
                        .navigation();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="跳转到Fragment"><a href="#跳转到Fragment" class="headerlink" title="跳转到Fragment"></a>跳转到Fragment</h3><blockquote>
<p>1.先获取到Fragment<br>2.在Activity中将该Fragment加载到容器中  </p>
</blockquote>
<pre class="line-numbers language-html"><code class="language-html">//1. 获取到目标Fragment
Fragment fragment = (Fragment) ARouter.getInstance().build(ARouterConstants.FRGAMENT_URL).navigation();
//2. 在Activity中加载该Frgment
getSupportFragmentManager()
        .beginTransaction()
        .replace(R.id.container, fragment)
        .commit();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="监听路由操作，回调响应"><a href="#监听路由操作，回调响应" class="headerlink" title="监听路由操作，回调响应"></a>监听路由操作，回调响应</h3><pre class="line-numbers language-html"><code class="language-html">ARouter.getInstance()
        .build(ARouterConstants.ACTIVITY_URL_HOST)
        .navigation(MDActivity.this, new NavigationCallback() {

            @Override
            public void onFound(Postcard postcard) {
                // 找到目标
            }

            @Override
            public void onLost(Postcard postcard) {
                // 丢失目标
            }

            @Override
            public void onArrival(Postcard postcard) {
                // 已经跳转到目标页面
            }

            @Override
            public void onInterrupt(Postcard postcard) {
                // 跳转被拦截
            }
        });
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="拦截器的使用"><a href="#拦截器的使用" class="headerlink" title="拦截器的使用"></a>拦截器的使用</h3><pre class="line-numbers language-html"><code class="language-html">/**
 * priority: 优先级，适用于多个拦截器的情况。
 */
@Interceptor(priority = 8,name = "拦截器")
public class MyInterceptor implements IInterceptor{
    @Override
    public void process(Postcard postcard, InterceptorCallback callback) {

        // 如果目标是"影视页面"
        if(postcard.getPath().equals(ARouterConstants.FRGAMENT_URL_MOVIE)){
            // 如果没有登录，跳转到登陆页面。
            if(true){
                postcard.setPath(ARouterConstants.FRGAMENT_URL_LOGIN);
            }
            // 也可以增加参数
            postcard.withString("account", "10001");
        }

        /**
         * 继续跳转或者终止跳转，如果不调用，路由直接结束。
         */
        // 1.继续跳转
        callback.onContinue(postcard);

        // 2.终止跳转
        //callback.onInterrupt(null)
        //callback.onInterrupt(new RuntimeException()) // 抛出异常
    }

    @Override
    public void init(Context context) {
        // 会在sdk初始化的时候调用且仅调用一次
        Log.d("feather","拦截器初始化");
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在触发路由操作后，拦截器的process方法并没有调用  </p>
<pre class="line-numbers language-html"><code class="language-html">出现该场景是在路由到Fragment时出现，Activity不会出现该问题。
根据官方的Issue和源码，Fragment采用绿色通道，不会进行拦截，因此无法使用拦截器拦截Fragment的跳转。
解决办法:
    1. 使用PathReplaceService(只能根据判断来修改Path，感觉用处不大)
    2. 不能直接navigation目标Fragment了，Navigation一个Activity，并且将Fragment通过参数传入，这样就能被拦截器所拦截，并进行后续的处理。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="跳转到Uri指定的目标"><a href="#跳转到Uri指定的目标" class="headerlink" title="跳转到Uri指定的目标"></a>跳转到Uri指定的目标</h3><p>AndroidManifest中设置  </p>
<pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.LoginActivity<span class="token punctuation">"</span></span>
        <span class="token attr-name">xxx</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span>
                <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>feather<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>www.feather.com<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1226<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Activity中指定Path  </p>
<pre class="line-numbers language-html"><code class="language-html">@Route(path = ARouterConstants.ACTIVITY_URL_LOGIN)
public class LoginActivity{
  xxx
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过Uri进行跳转  </p>
<pre class="line-numbers language-html"><code class="language-html">// 1. 默认路径
Uri uri = Uri.parse(ACTIVITY_URL_LOGIN);
ARouter.getInstance().build(uri).navigation();

// 2. 完整路径
Uri uri = Uri.parse("feather://www.feather.com:1226" + ACTIVITY_URL_LOGIN);
ARouter.getInstance().build(uri).navigation();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="带参数跳转并获取到参数"><a href="#带参数跳转并获取到参数" class="headerlink" title="带参数跳转并获取到参数"></a>带参数跳转并获取到参数</h3><pre class="line-numbers language-html"><code class="language-html">//携带参数跳转
ARouter.getInstance().build(ARouterConstants.ACTIVITY_URL_LOGIN)
                        .withString("name", "feather")
                        .withInt("age", 18)
                        .withBoolean("male", true)
                        .navigation();

// 获取到参数(变量名和参数名一致)
@Route(path = ARouterConstants.ACTIVITY_URL_LOGIN)
public class LoginActivity extends AppCompatActivity{
    @Autowired
    public String name;
    @Autowired
    public int age;
    @Autowired
    public boolean male;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        ARouter.getInstance().inject(this);
        //显示
        Logger.getLogger("Login").info("name = " + name + " age = " + age + " sex(is male) = " + male);
    }
}

//获取到参数(变量名和参数名不一致)
@Route(path = ARouterConstants.ACTIVITY_URL_LOGIN)
public class LoginActivity extends AppCompatActivity{

    @Autowired(name = "name")
    public String mName;
    @Autowired(name = "age")
    public int mAge;
    @Autowired(name = "male")
    public boolean mIsMale;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        //需要注入
        ARouter.getInstance().inject(this);
        //显示
        Logger.getLogger("Login")
             .info("name = " + mName +
                "\n age = " + mAge +
                "\n sex(is male) = " + mIsMale);
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加进入动画，退出动画"><a href="#添加进入动画，退出动画" class="headerlink" title="添加进入动画，退出动画"></a>添加进入动画，退出动画</h3><pre class="line-numbers language-html"><code class="language-html">低版本：  
ARouter.getInstance()
       .build(ARouterConstants.ACTIVITY_URL_PROFILE)
       //参数1为打开的Activity的进入动画，参数2为当前的Activity的退出动画
       .withTransition(R.anim.router_scale_in, R.anim.router_scale_out)
       .navigation(StarActivity.this);
高版本动画(API >=16)  
// 设置动画效果


if (Build.VERSION.SDK_INT >= 16) {
    ActivityOptionsCompat compat = ActivityOptionsCompat.
            makeScaleUpAnimation(v, v.getWidth() / 2, v.getHeight() / 2, 0, 0);

    ARouter.getInstance()
            .build(ARouterConstants.ACTIVITY_URL_PROFILE)
            .withOptionsCompat(compat)
            .navigation(StarActivity.this);
} else {
    Toast.makeText(this, "API &lt; 16,不支持新版本动画", Toast.LENGTH_SHORT).show();
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="网页url跳转Activity"><a href="#网页url跳转Activity" class="headerlink" title="网页url跳转Activity"></a>网页url跳转Activity</h3><p>效果：点击一个web页面上面的链接，就能跳转到我们的APP页面<br>思路：</p>
<ol>
<li>创建中转Activity(SchemeFilterActivity)</li>
<li>AndroidManifest中对中转Activity进行设置</li>
<li>在中转Activity中进行对应页面的跳转。</li>
</ol>
<h2 id="ARouter组件间通信，模块间调用"><a href="#ARouter组件间通信，模块间调用" class="headerlink" title="ARouter组件间通信，模块间调用"></a>ARouter组件间通信，模块间调用</h2><p>1 、子模块定义一个与主模块通信的接口ISkill继承自IProvider   </p>
<pre class="line-numbers language-html"><code class="language-html">public interface ISkill extends IProvider {
    public void eat();
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>2、 主模块定义一个ISkill实现类ISkillImpl   </p>
<pre class="line-numbers language-html"><code class="language-html">@Route(path = "/app/ISkillImpl")
public class ISkillImpl implements ISkill {

    @Override
    public void eat() {
        Log.i("TAG", "大王叫我来巡山!");
    }

    @Override
    public void init(Context context) {
    }
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3 、子模块通过ARouter+反射去获取这个ISkillImpl的实例化对象  </p>
<pre class="line-numbers language-html"><code class="language-html">ISkill impl=ARouter.getInstance().build("/app/ISkillImpl").navigation();
impl.eat();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4 、通过3的实例化对象进行通信  </p>
<h2 id="ROOM数据库框架实践"><a href="#ROOM数据库框架实践" class="headerlink" title="ROOM数据库框架实践"></a>ROOM数据库框架实践</h2><p>Room 持久性库在 SQLite 上提供了一个抽象层，以便在充分利用 SQLite 的强大功能的同时，能够流畅地访问数据库。具体来说，Room 具有以下优势：<br>针对 SQL 查询的编译时验证。<br>可最大限度减少重复和容易出错的样板代码的方便注解。<br>简化了数据库迁移路径。<br>出于这些方面的考虑，我们强烈建议您使用 Room，而不是直接使用 SQLite API</p>
<p>Room 包含 3 个重要部分：</p>
<blockquote>
<p>数据库：包含数据库持有者，并作为应用已保留的持久关系型数据的底层连接的主要接入点。<br>Entity：表示数据库中的表。这是一个Model类，对应于数据库中的一张表。Entity类是Sqlite表结构在Java类的映射。<br>DAO：包含用于访问数据库的方法。  </p>
</blockquote>
<h3 id="位置"><a href="#位置" class="headerlink" title="位置"></a>位置</h3><pre class="line-numbers language-html"><code class="language-html">创建成功的数据库在虚拟机下data/data/app程序包/database/下的三个文件  
数据库名xxdb  
数据库名xxdb-shm  
数据库名xxdb-wal 

取得的实例是以读写的方式打开数据库之后没有关闭数据库,加上db.close();代码修改之后，运行之后选中databases右键Synchronize,然后*.shm*.wal文件会消失只保留一个db文件  

File->Settings->Plugins 输入Database搜索，安装插件Database Navigator  
并重启Android Studio就可以看到主菜单栏里面多了一个DB Browser窗口
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h3><pre class="line-numbers language-html"><code class="language-html">android{
    defaultConfig {
        。。。。。。
        javaCompileOptions {
            annotationProcessorOptions {
                arguments = ["room.schemaLocation": "$projectDir/schemas".toString()]
            }
        }
        。。。。。。
    }
}
。。。。。。
dependencies {
    implementation "android.arch.persistence.room:runtime:1.0.0"
    annotationProcessor "android.arch.persistence.room:compiler:1.0.0"
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建实体类"><a href="#创建实体类" class="headerlink" title="创建实体类"></a>创建实体类</h3><pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;
import androidx.room.ColumnInfo;
import androidx.room.Entity;
import androidx.room.PrimaryKey;

//@Entity注释一个实体 tableName 数据库中的表名
@Entity
public class User {
    @PrimaryKey
    public int uid;

    @ColumnInfo(name = "first_name")
    public String firstName;

    @ColumnInfo(name = "last_name")
    public String lastName;

    public User(String firstName,String lastName){
        this.firstName=firstName;
        this.lastName=lastName;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建数据库接口DAO"><a href="#创建数据库接口DAO" class="headerlink" title="创建数据库接口DAO"></a>创建数据库接口DAO</h3><p>@Insert,@Delelte,@Update和@Query这个会点SQL知识的应该都知道这个增删改查，只有@Query的方法后面要改查询语句，并且返回类型也是自己改的。varary里的arr:Product是可变参数，可以列入多个，当然可以再复写一个List<product>的方法，直接传入列表也可以。</product></p>
<p>@Transaction就是开启事务，我把增，删，改都加入了事务。</p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;

import java.util.List;

import androidx.room.Dao;
import androidx.room.Delete;
import androidx.room.Insert;
import androidx.room.Query;
import androidx.room.Update;
import java.util.List;
@Dao
public interface UserDao {
    @Query("SELECT * FROM user")
    List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span><span class="token punctuation">></span></span> getAll();

    @Query("SELECT * FROM user WHERE uid IN (:userIds)")
    List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span><span class="token punctuation">></span></span> loadAllByIds(int[] userIds);

    @Query("SELECT * FROM user WHERE first_name LIKE :first AND " +
            "last_name LIKE :last LIMIT 1")
    User findByName(String first, String last);

    @Insert
    void insertAll(User... users);

    @Insert
    void insertUser(User user);

    @Delete
    void delete(User user);
    @Update
    void updateUser(User user);
}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建数据库DataBase"><a href="#创建数据库DataBase" class="headerlink" title="创建数据库DataBase"></a>创建数据库DataBase</h3><pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;

import android.content.Context;

import androidx.room.Database;
import androidx.room.Room;
import androidx.room.RoomDatabase;

@Database(entities = {User.class}, version = 1)
public abstract class AppDatabase extends RoomDatabase {
    private static final String DATABASE_NAME="mytestdbzs";
    private static AppDatabase databaseInstance;
    public static synchronized AppDatabase getInstance(Context context){
        if(databaseInstance==null){
            databaseInstance= Room.databaseBuilder(context.getApplicationContext(),AppDatabase.class,DATABASE_NAME).build();
        }
        return databaseInstance;
    }
    public abstract UserDao getuserDao();
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="activity里操作数据库"><a href="#activity里操作数据库" class="headerlink" title="activity里操作数据库"></a>activity里操作数据库</h3><p>不可以在主线程进行数据库操作<br>和LiveData一样在方法执行的时候，首先对线程做了判断。比如LiveData的setVaule方法，在第一步就判断了，如果不是主线程则抛异常。这个应该也差不多。  </p>
<pre class="line-numbers language-html"><code class="language-html"> AppDatabase db;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        new Thread(new Runnable() {
            @Override
            public void run() {
                db=AppDatabase.getInstance(getApplicationContext());
//                db.getuserDao().insertUser(new User("zhu", "wen"));
                List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>User</span><span class="token punctuation">></span></span> a=db.getuserDao().getAll();
                Log.d("xxxxxxxxxx",":"+a.size()+a.get(0).firstName);
                db.close();
            }
        }).start();
    }

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Androidstudio环境下使用EventBus"><a href="#Androidstudio环境下使用EventBus" class="headerlink" title="Androidstudio环境下使用EventBus"></a>Androidstudio环境下使用EventBus</h2><p>EventBus是一个订阅/发布消息总线，实现在应用程序里面，组件之间，线程之间的通信。因为event是任意的类型，所以这个使用起来非常方便。  </p>
<h3 id="eventbus中的角色"><a href="#eventbus中的角色" class="headerlink" title="eventbus中的角色"></a>eventbus中的角色</h3><p>event:当然就是事件啦<br>subscriber：事件的订阅者，先注册，接收特定的对象，并通过onEventXXX（）来回收处理事&lt;件。<br>Publisher：事件的发布者，通过post发布信息。  </p>
<h3 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h3><ol>
<li>定义一个事件(event) </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">public class FirstEvent {
     private String msg;
     public FirstEvent(String str){
         msg = str;
     }
     public String getMsg(){
         return msg;
     }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>注册一个订阅者  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">EventBus.getDefault().register(this);
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="3">
<li>发布一个事件  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">//例如当点击button后发布事件  
    btn = (Button)findViewById(R.id.second_btn);
    btn.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            //发布一个事件
            EventBus.getDefault().post(new FirstEvent("this is an event. "));
        }
    });
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>接受处理一个事件 </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">public void onEventMainThrend(FirstEvent event){
    String str = "this is in main activity , "+event.getMsg();
    Log.d("yuqt",str);
    tv.setText(str);
    Toast.makeText(this,str,Toast.LENGTH_LONG).show();
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>注销事件订阅  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">protected void onDestroy() {
    super.onDestroy();
    EventBus.getDefault().unregister(this);
} 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="处理事件的方式"><a href="#处理事件的方式" class="headerlink" title="处理事件的方式"></a>处理事件的方式</h3><p>onEventXXXX函数共四种  </p>
<table>
<tbody><tr>
<th>函数名</th><th>含义</th><th>ThreadMode</th>
</tr>
<tr>
<td>onEvent</td><td>事件处理在事件发送的那个线程执行</td><td>PostThread</td>
</tr>
<tr>
<td>onEventMainThread</td><td>事件在主线程-UI线程执行</td><td>MainThread</td>
</tr>
<tr>
<td>onEventBackgroundThread</td><td>事件在一个后台线程执行（就一个后台线程）</td><td>BackgroundThread</td>
</tr>
<tr>
<td>onEventAsync</td><td>事件会单独启动一个线程执行(每个事件都会启动一个线程)</td><td>Async</td>
</tr>
</tbody></table>  

<h3 id="添加依赖-2"><a href="#添加依赖-2" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>module下的在build.gradle 文件里面，dependencies目录下添加这一句话,在连网的情况下，build工程，as会自动去网上下载相应的jar包。  </p>
<pre class="line-numbers language-html"><code class="language-html">compile 'de.greenrobot:eventbus:2.4.0'
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="RecyclerView列表"><a href="#RecyclerView列表" class="headerlink" title="RecyclerView列表"></a>RecyclerView列表</h2><p>RecyclerView它可以说是一个增强版的ListView。ListView由于其强大的功能，在过去的Android 开发当中可以说是贡献卓越。不过ListView并不是完全没有缺点的，比如说如果我们不使用一些技巧来提升它的运行效率,那么ListView的性能就会非常差。还有，ListView 的扩展性也不够好。为此，Android 提供了一个更强大的滚动控件– RecyclerView。 ,不仅可以轻松实现和ListView同样的效果,还优化了ListView中存在的各种不足之处。目前Android官方更加推荐使用RecyclerView。  </p>
<pre class="line-numbers language-html"><code class="language-html">implementation 'com.android.support:recyclerview-v7:28.0.0'
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>activity_main.xml中定义一个RecyclerView即可。  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.recyclerview.widget.RecyclerView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/recycler_view<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">></span></span>  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>子项的布局文件  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">//fruit_item.xml  
<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ImageView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/fruit_image<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/fruit_name<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginLeft</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center_vertical<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>子项实体类  </li>
</ol>
<pre class="line-numbers language-html"><code class="language-html">//Fruit.java  

package com.example.hiemptyactivity;
public class Fruit {
    private String name;
    private int imageID;
    public Fruit(String name, int imageID) {
        this.name = name;
        this.imageID = imageID;
    }
    public String getName() {
        return name;
    }
    public int getImageID() {
        return imageID;
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>子项实体类对recyclerView的适配器  </li>
</ol>
<p>给RecyclerView定义一个适配器。FruitAdapter继承自 RecyclerView.Adapter，并指定其泛型为FruitAdapter.ViewHolder。ViewHolder是我们定义在FruitAdapter的一个内部类。  ViewHolder要继承自RecyclerView . ViewHolder。然后ViewHolder的构造函数中要传入一个View参数,这个参数通常就是RecyclerView 子项的最外层布局，那么我们就可以通过indViewById( )方法来获取到布局中的ImageView 和TextView的实例。<br>由于我们继承了RecyclerView.Adapter，那么需要重写三个方法。onCreateViewHolder()、onBindViewHolder()和 getItemCount()这 3个方法。  </p>
<p>onCreateViewHolder(方法是用于创建ViewHolder实例的,我们在这个方法中将fruit_ item 布局加载进来，然后创建一个ViewHolder实例，并把加载出来的布局传人到构造函数当中，最后将ViewHolder的实例返回。  </p>
<p>onBindViewHolder()方法是用于对RecyclerView子项的数据进行赋值的,会在每个子项被滚动到屏幕内的时候执行,这里我们通过position参数得到当前项的Fruit实例，然后再将数据设置到ViewHolder的ImageView和TextView当中即可。  </p>
<p>getItemCount()方法就非常简单了,它用于告诉RecyclerView -共有多少子项，直接返回数据源的长度就可以了。  </p>
<pre class="line-numbers language-html"><code class="language-html">//FruitAdapter.java  
package com.example.hiemptyactivity;

import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.RecyclerView;

import java.util.List;

public class FruitAdapter extends RecyclerView.Adapter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FruitAdapter.ViewHolder</span><span class="token punctuation">></span></span> {
    private List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fruit</span><span class="token punctuation">></span></span> mFruitList;
    @NonNull
    @Override
    public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        //用来创建ViewHolder实例，再将加载好的布局传入构造函数，最后返回ViewHolder实例
        View view= LayoutInflater.from(parent.getContext()).inflate(R.layout.fruit_item,null);
        ViewHolder holder=new ViewHolder(view);
        return holder;
    }
    public FruitAdapter(List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fruit</span><span class="token punctuation">></span></span> fruitList){
        mFruitList=fruitList;
    }
    @Override
    public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
        //用于对RecyclerView的子项进行赋值，会在每个子项滚动到屏幕内的时候执行
        Fruit fruit=mFruitList.get(position);
        holder.fruitImage.setImageResource(fruit.getImageID());
        holder.fruitName.setText(fruit.getName());
    }

    @Override
    public int getItemCount() {
        return mFruitList.size();
    }

    public static class ViewHolder extends RecyclerView.ViewHolder{
        ImageView fruitImage;
        TextView fruitName;

        public ViewHolder(@NonNull View itemView) {
            super(itemView);
            fruitImage=itemView.findViewById(R.id.fruit_image);
            fruitName=itemView.findViewById(R.id.fruit_name);
        }
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>MainActivity  </li>
</ol>
<p>在这里使用initFruits()方法，用于初始化所有的水果数据。接着在onCreate()方法中我们先获取到RecyclerView 的实例，然后创建了一个LinearLayout-Manager对象,并将它设置到RecyclerView当中。LayoutManager 用于指定RecyclerView的布局方式，这里使用的LinearLayoutManager是线性布局的意思，可以实现和ListView类似的效果（要实现横向的话可以取消注释试一下）。接下来我们创建了FruitAdapter的实例，并将水果数据传人到Frui tAdapter的构造函数中，最后调用RecyclerView的setAdapter()方法来完成适配器设置,这样RecyclerView和数据之间的关联就建立完成了。</p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;

import androidx.appcompat.app.AppCompatActivity;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import android.os.Bundle;

import java.util.ArrayList;
import java.util.List;

public class MainActivity extends AppCompatActivity {

    private List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fruit</span><span class="token punctuation">></span></span> fruitList=new ArrayList&lt;>();
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        initFruits();
        RecyclerView recyclerView=findViewById(R.id.recycler_view);
        LinearLayoutManager layoutManager=new LinearLayoutManager(this);
        layoutManager.setOrientation(LinearLayoutManager.VERTICAL);
        recyclerView.setLayoutManager(layoutManager);
        FruitAdapter adapter=new FruitAdapter(fruitList);
        recyclerView.setAdapter(adapter);
    }
    private void initFruits(){
        for(int i=0;i&lt;2;i++){
            Fruit apple = new Fruit("apple", R.drawable.a1);
            fruitList.add(apple);
            Fruit banana = new Fruit("banana", R.drawable.a2);
            fruitList.add(banana);
            Fruit orange = new Fruit("orange", R.drawable.a1);
            fruitList.add(orange);
            Fruit watermelon = new Fruit("watermelon", R.drawable.a2);
            fruitList.add(watermelon);
            Fruit pear = new Fruit("pear", R.drawable.a1);
            fruitList.add(pear);
            Fruit grape = new Fruit("grape", R.drawable.a2);
            fruitList.add(grape);
            Fruit pineapple = new Fruit("pineapple", R.drawable.a1);
            fruitList.add(pineapple);
            Fruit strawberry = new Fruit("strawberry", R.drawable.a2);
            fruitList.add(strawberry);
            Fruit cherry = new Fruit("cherry", R.drawable.a1);
            fruitList.add(cherry);
            Fruit mango = new Fruit("mango", R.drawable.a2);
            fruitList.add(mango);

        }
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="类底部栏切换fragment页"><a href="#类底部栏切换fragment页" class="headerlink" title="类底部栏切换fragment页"></a>类底部栏切换fragment页</h2><ol>
<li>新建两个Fragment(Blank1Fragment、Blank2Fragment)，过程跟新建连个activity一样。  </li>
<li>最底部放两个按钮，点击后通过FrameLayout切换显示Fragment  </li>
</ol>
<p>activity_main.xml:  </p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/fragme_layout<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center_horizontal<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintBottom_toBottomOf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintStart_toStartOf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/btn1<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60dp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>clickable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>面积<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/btn2<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60dp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>clickable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>总里程<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MainActivity.java:  </p>
<pre class="line-numbers language-html"><code class="language-html">package com.example.hiemptyactivity;

import androidx.appcompat.app.AppCompatActivity;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        TextView btn1=findViewById(R.id.btn1);
        btn1.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Log.d("ddddd","12345");
                replaceFragment(new Blank1Fragment());
            }
        });
        TextView btn2=findViewById(R.id.btn2);
        btn2.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Log.d("ddddd","54321");
                replaceFragment(new Blank2Fragment());
            }
        });
    }

    private void replaceFragment(Fragment fragment) {
        FragmentManager fragmentManager = getSupportFragmentManager();
        FragmentTransaction transaction = fragmentManager.beginTransaction();
        transaction.replace(R.id.fragme_layout,fragment);
        transaction.addToBackStack(null);
        transaction.commit();
    }

}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="LiveEventBus"><a href="#LiveEventBus" class="headerlink" title="LiveEventBus"></a>LiveEventBus</h2><pre class="line-numbers language-html"><code class="language-html">implementation 'io.github.jeremyliao:live-event-bus-x:1.8.0'  


1 生命周期感知

 消息随时订阅，自动取消订阅

 告别消息总线造成的内存泄漏

 告别生命周期造成的崩溃

2 范围全覆盖的消息总线解决方案

 进程内消息发送

 App内，跨进程消息发送

 App之间的消息发送

3 更多特性支持

 免配置直接使用，懒人最爱

 支持Sticky粘性消息

 支持AndroidX

 支持延迟发送

 观察者的多种接收模式（全生命周期/激活状态可接受消息）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="订阅消息"><a href="#订阅消息" class="headerlink" title="订阅消息"></a>订阅消息</h3><p>以生命周期感知模式订阅消息  </p>
<pre class="line-numbers language-html"><code class="language-html">LiveEventBus
  .get("some_key", String.class)
  .observe(this, new Observer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>() {
      @Override
      public void onChanged(@Nullable String s) {
      }
  });
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以Forever模式订阅消息  </p>
<pre class="line-numbers language-html"><code class="language-html">LiveEventBus
  .get("some_key", String.class)
  .observeForever(observer);  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h3><p>不定义消息，直接发送  </p>
<pre class="line-numbers language-html"><code class="language-html">LiveEventBus
  .get("some_key")
  .post(some_value);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>先定义消息，在发送消息  </p>
<pre class="line-numbers language-html"><code class="language-html">//定义
public class DemoEvent implements LiveEvent {
    public final String content;
    public DemoEvent(String content) {
        this.content = content;
    }
}
//发送
LiveEventBus
        .get(DemoEvent.class)
        .post(new DemoEvent("Hello world"));
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><pre class="line-numbers language-html"><code class="language-html">public class ProductConnectEvent implements LiveEvent {
    public ProductState mProductState;
    public ProductConnectEvent(ProductState productState) {
        mProductState = productState;
    }
}

@Override
public void onProductConnect(BaseProduct baseProduct) {
    if (baseProduct.isConnected()) {
        LiveEventBus.get(ProductConnectEvent.class)
                .post(new ProductConnectEvent(ProductState.CONNECT));
    } else {
        LiveEventBus.get(ProductConnectEvent.class)
                .post(new ProductConnectEvent(ProductState.DISCONNECT));
    }
}

        LiveEventBus.get(ProductConnectEvent.class).observeSticky(this, productConnectEvent -> {
            switch (productConnectEvent.mProductState) {
            case CONNECT:
                mBinding.ivConnect.setImageResource(R.drawable.green_dot);
                break;
            case DISCONNECT:
                mBinding.ivConnect.setImageResource(R.drawable.red_dot);
                break;
            }
        });
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="MVVM再次实践"><a href="#MVVM再次实践" class="headerlink" title="MVVM再次实践"></a>MVVM再次实践</h2><p>viewmodel负责业务</p>
<pre class="line-numbers language-html"><code class="language-html">public class DronewaySettingVM extends ViewModel {
    public LiveData getArea(){
        return DwSets.newInstance().getArea();
    }
}


public class DwSets extends BaseObservable {
    public static DwSets mInstance=null;
    public static DwSets newInstance() {
        if(mInstance==null){
            mInstance= new DwSets();
        }
        return mInstance;
    }
    MutableLiveData<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> mutableLiveData_bottom_1_area=new MutableLiveData<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span>();;
    public void setBottom_1_area(String bottom_1_area){
        mutableLiveData_bottom_1_area.postValue(bottom_1_area);
    }
    public MutableLiveData<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String</span><span class="token punctuation">></span></span> getArea(){
        return mutableLiveData_bottom_1_area;
    }
}

public class DronewaySettingFragment extends BaseFragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FragmentDronewaySettingBinding</span><span class="token punctuation">></span></span> {
    private DronewaySettingVM mVM;
    public DwSets dwSets;

    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
        View view=super.onCreateView(inflater, container, savedInstanceState);
        mVM=new ViewModelProvider(requireActivity()).get(DronewaySettingVM.class);
        return view;
    }

    @Override
    protected void initViewData(@NonNull View view) {
        // 观察、监听改变
        mVM.getArea().observe(this, new Observer() {
            @Override
            public void onChanged(Object o) {
                mBinding.dwsettingBottomArea.setText(o.toString());
            }
        });
    }

    // 改变值
    // DwSets.newInstance().setBottom_1_area("6666");
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            
            
            
            <div class="reprint1">
                <p>
                    <span class="reprint1-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://127.0.0.1/diary" class="b-link-green">车舟慢</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/diary/2022/11/04/diary-20221104-1/" class="b-link-green">Android学习-2</a>
                </p>
            </div>

        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }
	
	/*zs shuai*/
	#vcomments{
		display:none;
	}
	
    /* valine 评论框增加背景图片 */
    #vcomments textarea {
        box-sizing: border-box;
        background: url("") 100% 100% no-repeat;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    /* 修复评论第一行位置错位 */
    .v .vlist .vcard {
    padding-top: 2.5em !important ;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/libs//libs/jQuery-emoji/dist/css/jquery.emoji.css">
<script src="/libs//libs/jQuery-emoji/dist/js/jquery.emoji.min.js"></script>
<script src="/libs//libs/jQuery-emoji/dist/js/emoji.list.js"></script> -->
<script>
    new Valine({
        el: '#vcomments',
        appId: '2Kc1yifl00dRA6CYQxICVIe4-MdYXbMMI',
        appKey: 'xni6ILbDL2WVE4HDucMuDtx7',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: '',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go ヾﾉ≧∀≦)o ',

    });

//     function parse_emoji() {
//     jQuery(".vcontent").emojiParse({
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists   // 注：详见 js/emoji.list.js
//     });
//   }
  
//   setTimeout(function() {
//     // jQuery emoji 解析
//     parse_emoji();
//     // jquery emoji 初始化
//     jQuery(".veditor").emoji({
//       showTab: true,
//       animation: 'slide',
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists  // 注：详见 js/emoji.list.js
//     });
//     jQuery(".vmore").on("click", function() {
//       setTimeout(function() {
//         parse_emoji();
//       }, 500);
//     });
//   }, 800)

</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/diary/2022/11/07/diary-20221107-1/">
                    <div class="card-image">
                        
                        
                        <img src="/diary/medias/featureimages/26.jpg" class="responsive-img" alt="大疆msdk学习">
                        
                        <span class="card-title">大疆msdk学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            标准DJI_Go的UI布局功能
首先，我们添加dji.ux.widget.FPVWidget和dji.ux.widget.FPVOverlayWidget元素来显示第一人称视图（FPV）  

在屏幕顶部，我们创建一个LinearLayou
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-11-07
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/diary/tags/MSDK/" target="_blank">
                        <span class="chip bg-color">MSDK</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/diary/2022/10/19/diary-20221019-1/">
                    <div class="card-image">
                        
                        
                        <img src="/diary/medias/featureimages/30.jpg" class="responsive-img" alt="c++协议与序列化">
                        
                        <span class="card-title">c++协议与序列化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            序列化和反序列化要想使用网络框架的API来传输结构化的数据，必须得先实现结构化的数据与字节流之间的双向转换。这种将结构化数据转换成字节流的过程，称为序列化，反过来转换，就是反序列化。  
简单来说，序列化就是将对象实例的状态转换为可保持或传
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-10-19
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/diary/tags/协议/" target="_blank">
                        <span class="chip bg-color">协议</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 车舟慢<br />'
            + '作者: <br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/diary/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            

            <br>
            <span id="sitetime"></span><span class="my-face">ღゝ◡╹)ノ♡</span>
            <br>

            

            
            <!--
            
			
                &nbsp; | &nbsp;字数统计:&nbsp;
    <span class="white-color">650.5k</span> 字  
			
            
			
			-->

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">

 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=617641594@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>






    <a href="http://wpa.qq.com/msgrd?v=3&uin=617641594&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的QQ空间" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>




<!--

    <a href="/diary/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>

--></div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2020, 5, 1, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已坚持运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>
<script src="/diary/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/diary/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="/diary/libs/materialize/materialize.min.js"></script>
        <script src="/diary/libs/masonry/masonry.pkgd.min.js"></script>
        <script src="/diary/libs/aos/aos.js"></script>
        <script src="/diary/libs/scrollprogress/scrollProgress.min.js"></script>
        <script src="/diary/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script src="/diary/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->



        
            <script src="/diary/libs/others/clicklove.js"></script>
        

        

        
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

       
        

        
        

    
        

    
        

        

        
        

        
        

        
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" src="/diary/libs/background/ribbon-dynamic.js"><\/script>');
            }
            </script>
        

    <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>
</html>